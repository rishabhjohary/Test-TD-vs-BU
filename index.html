<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economic Flow Analysis</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* ========== NEW CENTRAL CONTROLS STYLES ========== */
        .central-controls-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 0 auto 30px auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #dee2e6;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            max-width: 500px;
        }
        
        .central-controls-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .central-controls-buttons {
            display: flex;
            gap: 12px;
        }
        
        .central-control-btn {
            padding: 8px 18px;
            border: 1px solid #adb5bd;
            background: white;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .central-control-btn:hover {
            background: #f8f9fa;
            border-color: #6c757d;
        }
        
        .central-control-btn.restart {
            background: #1e88e5;
            color: white;
            border-color: #1e88e5;
        }
        
        .central-control-btn.pause {
            background: #ff8f00;
            color: white;
            border-color: #ff8f00;
        }
        
        .time-elapsed {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a1a1a;
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            min-width: 100px;
            text-align: center;
        }
        
        /* ========== ALL EXISTING CSS REMAINS THE SAME ========== */
        /* Base reset */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            line-height: 1.6;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            padding: 40px 0 30px;
            margin-bottom: 30px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 1.1rem;
            color: #495057;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Main container */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        @media (max-width: 1100px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        /* Model panel */
        .model-panel {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #dee2e6;
        }

        .model-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid;
        }

        .model-header.td { border-bottom-color: #1e88e5; }
        .model-header.bu { border-bottom-color: #ff8f00; }

        .model-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .model-title.td { color: #1e88e5; }
        .model-title.bu { color: #ff8f00; }

        .model-controls {
            display: flex;
            gap: 8px;
        }

        .control-btn {
            padding: 6px 14px;
            border: 1px solid #adb5bd;
            background: white;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #f8f9fa;
            border-color: #6c757d;
        }

        /* Primary visualization container */
        .viz-container {
            height: 450px;
            position: relative;
            margin-bottom: 25px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            overflow: hidden;
        }

        /* Secondary visualization (mechanization layer) */
        .mechanization-container {
            height: 300px;
            position: relative;
            margin-top: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            overflow: hidden;
        }

        /* Circular visualization elements */
        .center-stats {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 50;
            pointer-events: none;
        }

        .gdp-display {
            font-size: 2.2rem;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .top-down .gdp-display { color: #1e88e5; }
        .bottom-up .gdp-display { color: #ff8f00; }

        .velocity-display {
            font-size: 0.95rem;
            color: #6c757d;
        }

        .total-metric {
            position: absolute;
            top: 25px;
            right: 30px;
            text-align: right;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 14px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .metric-label-small {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .metric-value-small {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 3px;
        }

        .top-down .metric-value-small { color: #1e88e5; }
        .bottom-up .metric-value-small { color: #ff8f00; }

        .flow-legend {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 18px;
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Flow description */
        .flow-description {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #dee2e6;
        }

        .flow-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .flow-step {
            display: inline-block;
            padding: 3px 10px;
            background: #e9ecef;
            border-radius: 10px;
            font-size: 0.8rem;
            color: #495057;
            margin-bottom: 12px;
        }

        .flow-text {
            color: #495057;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .flow-details {
            background: white;
            padding: 14px;
            border-radius: 6px;
            border-left: 3px solid;
            margin-top: 14px;
            font-size: 0.9rem;
        }

        .flow-details.td { border-left-color: #1e88e5; }
        .flow-details.bu { border-left-color: #ff8f00; }

        .detail-section {
            margin-bottom: 12px;
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-weight: 500;
            color: #343a40;
            margin-bottom: 4px;
        }

        .detail-value {
            color: #495057;
            line-height: 1.5;
        }

        /* Metrics grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: white;
            padding: 18px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .metric-card.td { border-top: 3px solid #1e88e5; }
        .metric-card.bu { border-top: 3px solid #ff8f00; }

        .metric-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .metric-value.td { color: #1e88e5; }
        .metric-value.bu { color: #ff8f00; }

        /* Additional metrics section */
        .additional-metrics {
            background: white;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            margin-bottom: 25px;
        }

        .additional-metrics-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 16px;
        }

        .additional-metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .additional-metric {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid;
        }

        .additional-metric.td { border-left-color: #1e88e5; }
        .additional-metric.bu { border-left-color: #ff8f00; }

        .additional-metric-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .additional-metric-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .additional-metric-value.td { color: #1e88e5; }
        .additional-metric-value.bu { color: #ff8f00; }

        /* Sector breakdown */
        .sector-breakdown {
            background: white;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .breakdown-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 16px;
        }

        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px;
        }

        @media (max-width: 768px) {
            .breakdown-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .sector-card {
            padding: 14px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid;
        }

        .sector-card.government { border-left-color: #673ab7; }
        .sector-card.corporate { border-left-color: #1e88e5; }
        .sector-card.msme { border-left-color: #00a152; }
        .sector-card.household { border-left-color: #ff8f00; }
        .sector-card.finance { border-left-color: #3949ab; }
        .sector-card.agriculture { border-left-color: #689f38; }

        .sector-name {
            font-size: 0.85rem;
            font-weight: 500;
            color: #343a40;
            margin-bottom: 6px;
        }

        .sector-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 3px;
        }

        .sector-change {
            font-size: 0.8rem;
            font-weight: 500;
        }

        .sector-change.positive { color: #00a152; }
        .sector-change.negative { color: #d32f2f; }

        /* Constraints section */
        .constraints-section {
            background: white;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            margin-top: 20px;
        }

        .constraints-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 12px;
        }

        .constraints-list {
            list-style: none;
            padding: 0;
        }

        .constraints-list li {
            padding: 6px 0;
            color: #495057;
            border-bottom: 1px solid #f1f3f5;
            font-size: 0.9rem;
        }

        .constraints-list li:last-child {
            border-bottom: none;
        }

        .constraints-list li.advantage { color: #00a152; }
        .constraints-list li.constraint { color: #d32f2f; }

        /* Model descriptions section */
        .model-descriptions {
            background: white;
            border-radius: 8px;
            padding: 35px;
            margin: 40px 0;
            border: 1px solid #dee2e6;
        }

        .model-descriptions-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 30px;
            text-align: center;
        }

        .model-descriptions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .model-desc-card {
            padding: 22px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .model-desc-card.td { border-top: 3px solid #1e88e5; }
        .model-desc-card.bu { border-top: 3px solid #ff8f00; }
        .model-desc-card.export { border-top: 3px solid #00a152; }
        .model-desc-card.consumption { border-top: 3px solid #673ab7; }
        .model-desc-card.public { border-top: 3px solid #3949ab; }

        .model-desc-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 12px;
        }

        .model-desc-text {
            color: #495057;
            line-height: 1.6;
            margin-bottom: 16px;
            font-size: 0.95rem;
        }

        .model-features {
            list-style: none;
            padding: 0;
            margin-top: 12px;
        }

        .model-features li {
            padding: 6px 0;
            color: #495057;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9rem;
        }

        .model-features li:last-child {
            border-bottom: none;
        }

        /* Policy insight section */
        .policy-insight {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 30px;
            margin: 40px 0;
            border-left: 5px solid #1e88e5;
        }

        .policy-insight-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1565c0;
            margin-bottom: 16px;
        }

        .policy-insight-content {
            color: #37474f;
            line-height: 1.7;
            font-size: 1rem;
        }

        /* Complexity note */
        .complexity-note {
            background: #fff3e0;
            border-radius: 8px;
            padding: 25px;
            margin: 40px 0;
            border-left: 5px solid #ff8f00;
        }

        .complexity-note-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #e65100;
            margin-bottom: 12px;
        }

        .complexity-note-content {
            color: #5d4037;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        /* Comparative Timeline CSS */
        .comparative-timeline {
            background: white;
            border-radius: 8px;
            padding: 35px;
            margin: 40px 0;
            border: 1px solid #dee2e6;
        }

        .timeline-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 30px;
            text-align: center;
        }

        .timeline-container {
            height: 400px;
            position: relative;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            padding: 20px;
        }

        .timeline-legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .legend-item-timeline {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-dot-timeline {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .td-dot { background: #1e88e5; }
        .bu-dot { background: #ff8f00; }

        .timeline-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        .timeline-btn {
            padding: 8px 20px;
            background: white;
            border: 1px solid #adb5bd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .timeline-btn:hover {
            background: #f8f9fa;
            border-color: #6c757d;
        }

        .timeline-btn.active {
            background: #1e88e5;
            color: white;
            border-color: #1e88e5;
        }

        .timeline-metric {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            font-size: 0.85rem;
            min-width: 150px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            pointer-events: none;
            z-index: 100;
        }

        .timeline-axis-label {
            font-size: 0.8rem;
            fill: #6c757d;
        }

        .timeline-grid line {
            stroke: #e9ecef;
            stroke-width: 1;
        }

        .timeline-line {
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .timeline-line.td { stroke: #1e88e5; }
        .timeline-line.bu { stroke: #ff8f00; }

        .timeline-point {
            cursor: pointer;
            transition: r 0.2s;
        }

        .timeline-point:hover {
            r: 6;
        }

        .timeline-point.td { fill: #1e88e5; }
        .timeline-point.bu { fill: #ff8f00; }

        /* Mathematical Model Section */
        .mathematical-model {
            background: #e8f5e9;
            border-radius: 8px;
            padding: 35px;
            margin: 40px 0;
            border-left: 5px solid #2e7d32;
            font-family: 'Courier New', monospace;
        }

        .mathematical-model-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1b5e20;
            margin-bottom: 25px;
            text-align: center;
        }

        .equation-section {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #c8e6c9;
        }

        .equation-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 10px;
            border-bottom: 1px solid #e8f5e9;
            padding-bottom: 8px;
        }

        .equation {
            font-family: 'Cambria Math', serif;
            font-size: 1.1rem;
            color: #1a237e;
            margin: 10px 0;
            padding: 10px;
            background: #f1f8e9;
            border-radius: 4px;
            overflow-x: auto;
        }

        .calculation-step {
            margin: 12px 0;
            padding-left: 20px;
            border-left: 3px solid #4caf50;
        }

        .variable-def {
            font-size: 0.9rem;
            color: #455a64;
            margin-top: 3px;
            font-style: italic;
        }

        .result-box {
            background: #1b5e20;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 600;
        }

        .constraint-note {
            background: #fff3e0;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #ff8f00;
            margin: 20px 0;
            font-size: 0.95rem;
            color: #5d4037;
        }

        /* Assumptions section */
        .assumptions-section {
            background: #f3e5f5;
            border-radius: 8px;
            padding: 25px;
            margin: 40px 0;
            border-left: 5px solid #7b1fa2;
        }

        .assumptions-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #6a1b9a;
            margin-bottom: 12px;
        }

        .assumptions-list {
            list-style: none;
            padding: 0;
        }

        .assumptions-list li {
            padding: 8px 0;
            color: #4a148c;
            border-bottom: 1px solid #e1bee7;
            font-size: 0.95rem;
        }

        .assumptions-list li:last-child {
            border-bottom: none;
        }

        /* Insights section */
        .insights-section {
            background: white;
            border-radius: 8px;
            padding: 35px;
            margin: 40px 0;
            border: 1px solid #dee2e6;
        }

        .insights-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 25px;
            text-align: center;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 22px;
        }

        .insight-card {
            padding: 22px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .insight-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 10px;
        }

        .insight-card p {
            color: #495057;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 0;
            margin-top: 40px;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            font-size: 0.9rem;
        }

        .footer p {
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.5;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(33, 37, 41, 0.95);
            color: white;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            z-index: 1000;
            max-width: 250px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        /* Visualization elements */
        .sector-node {
            transition: r 0.3s;
            cursor: pointer;
        }

        .flow-particle {
            font-weight: 600;
            pointer-events: none;
        }

        .tax-particle {
            fill: #d32f2f;
        }

        .sector-label {
            font-size: 0.7rem;
            fill: #495057;
            text-anchor: middle;
            font-weight: 500;
            pointer-events: none;
        }

        /* Mechanization model styling */
        .mechanization-title {
            font-size: 1rem;
            font-weight: 600;
            color: #495057;
            margin: 15px 0 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }
        
        /* ENHANCED ANIMATION STYLES */
        .rupee-pulse {
            animation: rupeePulse 2s infinite;
        }
        
        @keyframes rupeePulse {
            0% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0.7; transform: scale(1); }
        }
        
        .tax-burst {
            animation: taxBurst 0.8s ease-out;
        }
        
        @keyframes taxBurst {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        .path-highlight {
            animation: pathPulse 3s infinite;
        }
        
        @keyframes pathPulse {
            0% { stroke-opacity: 0.3; }
            50% { stroke-opacity: 0.6; }
            100% { stroke-opacity: 0.3; }
        }
        
        .rupee-flow {
            animation: rupeeFlow 1s ease-in-out;
        }
        
        @keyframes rupeeFlow {
            0% { opacity: 0; transform: scale(0.8); }
            20% { opacity: 1; transform: scale(1.1); }
            80% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.9); }
        }
        
        /* ========== ENHANCED FLOW NETWORK VISUALIZATION ========== */
        .enhanced-network-container {
            position: relative;
            height: 500px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin: 20px 0;
            overflow: hidden;
        }

        .network-zoom-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            display: flex;
            gap: 8px;
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #adb5bd;
            background: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: 600;
            color: #495057;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: #f8f9fa;
            border-color: #6c757d;
        }

        .zoom-level {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.9);
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            font-size: 0.9rem;
            color: #495057;
        }

        .network-tooltip {
            position: absolute;
            background: rgba(33, 37, 41, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .network-node-enhanced {
            stroke: white;
            stroke-width: 2;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .network-node-enhanced:hover {
            stroke-width: 4;
            stroke: #ff8f00;
        }

        .network-link-enhanced {
            stroke: #adb5bd;
            stroke-width: 1.5;
            stroke-opacity: 0.4;
            fill: none;
            transition: stroke-opacity 0.3s;
        }

        .network-link-enhanced:hover {
            stroke-opacity: 0.8;
        }

        .sector-label-enhanced {
            font-size: 0.8rem;
            font-weight: 500;
            fill: #495057;
            text-anchor: middle;
            pointer-events: none;
        }

        .sub-sector-node {
            stroke: white;
            stroke-width: 1.5;
            transition: all 0.3s ease;
        }

        .sub-sector-link {
            stroke: rgba(0, 0, 0, 0.1);
            stroke-width: 1;
            stroke-dasharray: 3,3;
            fill: none;
        }

        .flow-path-enhanced {
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .flow-rupee-enhanced {
            font-weight: 700;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
            pointer-events: none;
        }

        .export-node { fill: #4CAF50; }
        .import-node { fill: #F44336; }
        .real-estate-node { fill: #FF9800; }
        .construction-node { fill: #795548; }
        .tech-node { fill: #2196F3; }
        .digital-node { fill: #3F51B5; }
        .education-node { fill: #9C27B0; }
        .healthcare-node { fill: #E91E63; }
        .energy-node { fill: #FFC107; }
        .utilities-node { fill: #00BCD4; }
        .transport-node { fill: #607D8B; }
        .logistics-node { fill: #8BC34A; }

        /* Simplified view */
        .network-simplified .sub-sector-node,
        .network-simplified .sub-sector-link {
            display: none;
        }

        .network-simplified .network-link-enhanced {
            stroke-width: 1;
            stroke-opacity: 0.3;
        }

        /* Detailed view */
        .network-detailed .sub-sector-node,
        .network-detailed .sub-sector-link {
            display: block;
        }

        .network-detailed .network-link-enhanced {
            stroke-width: 2;
            stroke-opacity: 0.6;
        }
        
        /* ========== GOD-LEVEL PIE CHART ========== */
        .pie-chart-master {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            border: 1px solid #dee2e6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .pie-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .pie-chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1a1a1a;
        }

        .pie-chart-controls {
            display: flex;
            gap: 10px;
        }

        .pie-control-btn {
            padding: 6px 12px;
            border: 1px solid #adb5bd;
            background: white;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pie-control-btn:hover {
            background: #f8f9fa;
            border-color: #6c757d;
        }

        .pie-control-btn.active {
            background: #1e88e5;
            color: white;
            border-color: #1e88e5;
        }

        .pie-chart-container-master {
            height: 400px;
            position: relative;
            display: flex;
            gap: 30px;
        }

        .pie-svg-container {
            flex: 1;
            position: relative;
        }

        .legend-container {
            width: 250px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            overflow-y: auto;
            max-height: 350px;
        }

        .legend-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #dee2e6;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin-bottom: 6px;
            border-radius: 4px;
            transition: background 0.2s;
            cursor: pointer;
        }

        .legend-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .legend-text {
            flex: 1;
            font-size: 0.9rem;
            color: #495057;
        }

        .legend-value {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 0.9rem;
        }

        .legend-percentage {
            font-size: 0.8rem;
            color: #6c757d;
            margin-left: 5px;
        }

        .pie-slice-master {
            stroke: white;
            stroke-width: 2;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .pie-slice-master:hover {
            stroke-width: 3;
            filter: brightness(1.1);
        }

        .pie-label-master {
            font-size: 0.9rem;
            font-weight: 500;
            fill: white;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .pie-center {
            fill: white;
            stroke: #dee2e6;
            stroke-width: 1;
        }

        .pie-center-text {
            font-size: 1rem;
            font-weight: 600;
            fill: #1a1a1a;
            text-anchor: middle;
            dominant-baseline: middle;
        }

        .pie-tooltip {
            position: absolute;
            background: rgba(33, 37, 41, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 1000;
            max-width: 250px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .pie-tooltip-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: white;
        }

        .pie-tooltip-value {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 5px 0;
        }

        .pie-tooltip-percentage {
            color: #ddd;
            font-size: 0.85rem;
        }

        .pie-animation-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .animation-speed {
            flex: 1;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .animation-speed-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: #1e88e5;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .speed-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <h1>Economic Flow Analysis</h1>
        <p>Comparing capital circulation in top-down versus bottom-up economic models. Simulation tracks ‚Çπ100 crore capital circulation in top-down vs bottom-up economic models.</p>
    </div>

    <!-- NEW CENTRAL CONTROLS PANEL -->
    <div class="central-controls-panel">
        <div class="central-controls-content">
            <div class="central-controls-title">Restart, Pause, Time elapsed: <span id="global-time-elapsed">0s</span></div>
            <div class="central-controls-buttons">
                <button class="central-control-btn restart" onclick="restartAllModels()">Restart</button>
                <button class="central-control-btn pause" onclick="pauseAllModels()" id="global-pause-btn">Pause</button>
            </div>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="main-container">
        <!-- Top-Down Model -->
        <div class="model-panel">
            <div class="model-header td">
                <div class="model-title td">Top-Down Capital Model</div>
                <div class="model-controls">
                    <button class="control-btn" onclick="restartModel('td')">Restart</button>
                    <button class="control-btn" onclick="toggleModel('td')" id="toggle-td">Pause</button>
                </div>
            </div>
            
            <!-- Primary visualization -->
            <div class="viz-container" id="viz-td">
                <div class="center-stats">
                    <div class="gdp-display" id="gdp-td">‚Çπ0</div>
                    <div class="velocity-display">Velocity: <span id="velocity-td">0.0</span></div>
                </div>
                <div class="total-metric">
                    <div class="metric-label-small">Tax Collected</div>
                    <div class="metric-value-small" id="tax-td">‚Çπ0</div>
                </div>
                <div class="flow-legend">
                    <div class="legend-item"><span class="legend-dot" style="background:#1e88e5;"></span> Capital</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#00a152;"></span> Production</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#ff8f00;"></span> Wages</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#d32f2f;"></span> Tax</div>
                </div>
            </div>

            <!-- Secondary mechanization view -->
            <div class="mechanization-title">Flow Network Visualization</div>
            <div class="mechanization-container" id="mech-td"></div>
            
            <!-- Enhanced Network Visualization -->
            <div class="enhanced-network-container" id="td-enhanced-network">
                <div class="zoom-level">Zoom: 100%</div>
                <div class="network-zoom-controls">
                    <button class="zoom-btn" onclick="zoomNetwork('td', 'in')">+</button>
                    <button class="zoom-btn" onclick="zoomNetwork('td', 'out')">‚àí</button>
                    <button class="zoom-btn" onclick="zoomNetwork('td', 'reset')">‚Üª</button>
                    <button class="zoom-btn" onclick="toggleNetworkDetail('td')">üîç</button>
                </div>
            </div>
            
            <!-- God-Level Pie Chart -->
            <div class="pie-chart-master" id="td-pie-master">
                <div class="pie-chart-header">
                    <div class="pie-chart-title">Real-Time Sector Distribution</div>
                    <div class="pie-chart-controls">
                        <button class="pie-control-btn active" onclick="changePieView('td', 'sectors')">Sectors</button>
                        <button class="pie-control-btn" onclick="changePieView('td', 'subsectors')">Sub-Sectors</button>
                        <button class="pie-control-btn" onclick="changePieView('td', 'flow')">Flow Direction</button>
                    </div>
                </div>
                <div class="pie-chart-container-master">
                    <div class="pie-svg-container" id="td-pie-svg-container"></div>
                    <div class="legend-container" id="td-pie-legend"></div>
                </div>
                <div class="pie-animation-controls">
                    <div class="animation-speed" onclick="changeAnimationSpeed('td', event)">
                        <div class="animation-speed-fill" id="td-speed-fill" style="width: 50%;"></div>
                    </div>
                    <div class="speed-label" id="td-speed-label">Speed: Normal</div>
                </div>
            </div>
            
            <div class="flow-description">
                <div class="flow-title" id="td-flow-title">Infrastructure Capital Deployment Phase</div>
                <div class="flow-step" id="td-flow-step">Month 0/36</div>
                <div class="flow-text" id="td-flow-text">Government allocates ‚Çπ100 crore for large-scale projects. ‚Çπ70.0Cr to corporations, ‚Çπ20.0Cr in financial system.</div>
                
                <div class="flow-details td" id="td-flow-details">
                    <div class="detail-section">
                        <div class="detail-label">Sub-sector Distribution:</div>
                        <div class="detail-value">Awaiting flow data...</div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-label">Tax Breakdown:</div>
                        <div class="detail-value">Corporate Tax: ‚Çπ0 | Income Tax: ‚Çπ0 | GST: ‚Çπ0</div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-label">Time Frame:</div>
                        <div class="detail-value">3-6 months for full deployment</div>
                    </div>
                </div>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card td">
                    <div class="metric-label">Capital Invested</div>
                    <div class="metric-value td" id="td-capital">‚Çπ100.0Cr</div>
                </div>
                <div class="metric-card td">
                    <div class="metric-label">Jobs Created</div>
                    <div class="metric-value td" id="td-jobs">0</div>
                </div>
                <div class="metric-card td">
                    <div class="metric-label">Tax Revenue</div>
                    <div class="metric-value td" id="td-tax">‚Çπ0</div>
                </div>
                <div class="metric-card td">
                    <div class="metric-label">Velocity</div>
                    <div class="metric-value td" id="td-velocity">0.0x</div>
                </div>
            </div>

            <!-- Additional Metrics -->
            <div class="additional-metrics">
                <div class="additional-metrics-title">Detailed Flow Metrics</div>
                <div class="additional-metrics-grid">
                    <div class="additional-metric td">
                        <div class="additional-metric-label">Amount in Circulation</div>
                        <div class="additional-metric-value td" id="td-amount">‚Çπ0</div>
                    </div>
                    <div class="additional-metric td">
                        <div class="additional-metric-label">Tax Generated</div>
                        <div class="additional-metric-value td" id="td-tax-generated">‚Çπ0</div>
                    </div>
                    <div class="additional-metric td">
                        <div class="additional-metric-label">GDP Contribution</div>
                        <div class="additional-metric-value td" id="td-gdp-contribution">‚Çπ0</div>
                    </div>
                    <div class="additional-metric td">
                        <div class="additional-metric-label">Velocity Impact</div>
                        <div class="additional-metric-value td" id="td-velocity-impact">0.0</div>
                    </div>
                </div>
            </div>
            
            <div class="sector-breakdown">
                <div class="breakdown-title">Sector Capital Distribution</div>
                <div class="breakdown-grid">
                    <div class="sector-card government">
                        <div class="sector-name">Government</div>
                        <div class="sector-value" id="td-sector-gov">‚Çπ0</div>
                        <div class="sector-change" id="td-sector-gov-change">0%</div>
                    </div>
                    <div class="sector-card corporate">
                        <div class="sector-name">Large Corporations</div>
                        <div class="sector-value" id="td-sector-corp">‚Çπ85.0Cr</div>
                        <div class="sector-change positive" id="td-sector-corp-change">+0%</div>
                    </div>
                    <div class="sector-card msme">
                        <div class="sector-name">MSMEs</div>
                        <div class="sector-value" id="td-sector-msme">‚Çπ0</div>
                        <div class="sector-change" id="td-sector-msme-change">0%</div>
                    </div>
                    <div class="sector-card household">
                        <div class="sector-name">Households</div>
                        <div class="sector-value" id="td-sector-house">‚Çπ0</div>
                        <div class="sector-change" id="td-sector-house-change">0%</div>
                    </div>
                    <div class="sector-card finance">
                        <div class="sector-name">Financial System</div>
                        <div class="sector-value" id="td-sector-fin">‚Çπ15.0Cr</div>
                        <div class="sector-change negative" id="td-sector-fin-change">-0%</div>
                    </div>
                    <div class="sector-card agriculture">
                        <div class="sector-name">Agriculture</div>
                        <div class="sector-value" id="td-sector-agri">‚Çπ0</div>
                        <div class="sector-change" id="td-sector-agri-change">0%</div>
                    </div>
                </div>
            </div>

            <!-- Constraints Section -->
            <div class="constraints-section">
                <div class="constraints-title">Model Constraints & Advantages</div>
                <ul class="constraints-list">
                    <li class="advantage">Large-scale impact when successful (infrastructure, factories)</li>
                    <li class="constraint">Slow velocity - money moves 1-2 times per year through system</li>
                    <li class="constraint">High risk concentration - few decision points control large sums</li>
                    <li class="advantage">Can create entire new industries from scratch</li>
                </ul>
            </div>
        </div>

        <!-- Bottom-Up Model -->
        <div class="model-panel">
            <div class="model-header bu">
                <div class="model-title bu">Bottom-Up Velocity Model</div>
                <div class="model-controls">
                    <button class="control-btn" onclick="restartModel('bu')">Restart</button>
                    <button class="control-btn" onclick="toggleModel('bu')" id="toggle-bu">Pause</button>
                </div>
            </div>
            
            <!-- Primary visualization -->
            <div class="viz-container" id="viz-bu">
                <div class="center-stats">
                    <div class="gdp-display" id="gdp-bu">‚Çπ0</div>
                    <div class="velocity-display">Velocity: <span id="velocity-bu">0.0</span></div>
                </div>
                <div class="total-metric">
                    <div class="metric-label-small">Tax Collected</div>
                    <div class="metric-value-small" id="tax-bu">‚Çπ0</div>
                </div>
                <div class="flow-legend">
                    <div class="legend-item"><span class="legend-dot" style="background:#ff8f00;"></span> Spending</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#00a152;"></span> MSMEs</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#1e88e5;"></span> Corporations</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#673ab7;"></span> Government</div>
                </div>
            </div>

            <!-- Secondary mechanization view -->
            <div class="mechanization-title">Flow Network Visualization</div>
            <div class="mechanization-container" id="mech-bu"></div>
            
            <!-- Enhanced Network Visualization -->
            <div class="enhanced-network-container" id="bu-enhanced-network">
                <div class="zoom-level">Zoom: 100%</div>
                <div class="network-zoom-controls">
                    <button class="zoom-btn" onclick="zoomNetwork('bu', 'in')">+</button>
                    <button class="zoom-btn" onclick="zoomNetwork('bu', 'out')">‚àí</button>
                    <button class="zoom-btn" onclick="zoomNetwork('bu', 'reset')">‚Üª</button>
                    <button class="zoom-btn" onclick="toggleNetworkDetail('bu')">üîç</button>
                </div>
            </div>
            
            <!-- God-Level Pie Chart -->
            <div class="pie-chart-master" id="bu-pie-master">
                <div class="pie-chart-header">
                    <div class="pie-chart-title">Real-Time Sector Distribution</div>
                    <div class="pie-chart-controls">
                        <button class="pie-control-btn active" onclick="changePieView('bu', 'sectors')">Sectors</button>
                        <button class="pie-control-btn" onclick="changePieView('bu', 'subsectors')">Sub-Sectors</button>
                        <button class="pie-control-btn" onclick="changePieView('bu', 'flow')">Flow Direction</button>
                    </div>
                </div>
                <div class="pie-chart-container-master">
                    <div class="pie-svg-container" id="bu-pie-svg-container"></div>
                    <div class="legend-container" id="bu-pie-legend"></div>
                </div>
                <div class="pie-animation-controls">
                    <div class="animation-speed" onclick="changeAnimationSpeed('bu', event)">
                        <div class="animation-speed-fill" id="bu-speed-fill" style="width: 50%;"></div>
                    </div>
                    <div class="speed-label" id="bu-speed-label">Speed: Normal</div>
                </div>
            </div>
            
            <div class="flow-description">
                <div class="flow-title" id="bu-flow-title">Immediate Consumption Activation</div>
                <div class="flow-step" id="bu-flow-step">Month 0/36</div>
                <div class="flow-text" id="bu-flow-text">‚Çπ100 crore directly to households and MSMEs. Daily transactions averaging ‚ÇπInfinity per day with 2.0x velocity.</div>
                
                <div class="flow-details bu" id="bu-flow-details">
                    <div class="detail-section">
                        <div class="detail-label">Sub-sector Distribution:</div>
                        <div class="detail-value">Awaiting flow data...</div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-label">Tax Breakdown:</div>
                        <div class="detail-value">GST: ‚Çπ0 | Income Tax: ‚Çπ0 | Corporate Tax: ‚Çπ0</div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-label">Time Frame:</div>
                        <div class="detail-value">1-7 days for initial spending</div>
                    </div>
                </div>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card bu">
                    <div class="metric-label">Daily Transactions</div>
                    <div class="metric-value bu" id="bu-transactions">0</div>
                </div>
                <div class="metric-card bu">
                    <div class="metric-label">Businesses Supported</div>
                    <div class="metric-value bu" id="bu-businesses">0</div>
                </div>
                <div class="metric-card bu">
                    <div class="metric-label">Tax Revenue</div>
                    <div class="metric-value bu" id="bu-tax">‚Çπ0</div>
                </div>
                <div class="metric-card bu">
                    <div class="metric-label">Velocity</div>
                    <div class="metric-value bu" id="bu-velocity">0.0x</div>
                </div>
            </div>

            <!-- Additional Metrics -->
            <div class="additional-metrics">
                <div class="additional-metrics-title">Detailed Flow Metrics</div>
                <div class="additional-metrics-grid">
                    <div class="additional-metric bu">
                        <div class="additional-metric-label">Amount in Circulation</div>
                        <div class="additional-metric-value bu" id="bu-amount">‚Çπ0</div>
                    </div>
                    <div class="additional-metric bu">
                        <div class="additional-metric-label">Tax Generated</div>
                        <div class="additional-metric-value bu" id="bu-tax-generated">‚Çπ0</div>
                    </div>
                    <div class="additional-metric bu">
                        <div class="additional-metric-label">GDP Contribution</div>
                        <div class="additional-metric-value bu" id="bu-gdp-contribution">‚Çπ0</div>
                    </div>
                    <div class="additional-metric bu">
                        <div class="additional-metric-label">Velocity Impact</div>
                        <div class="additional-metric-value bu" id="bu-velocity-impact">0.0</div>
                    </div>
                </div>
            </div>
            
            <div class="sector-breakdown">
                <div class="breakdown-title">Sector Capital Distribution</div>
                <div class="breakdown-grid">
                    <div class="sector-card government">
                        <div class="sector-name">Government</div>
                        <div class="sector-value" id="bu-sector-gov">‚Çπ0</div>
                        <div class="sector-change" id="bu-sector-gov-change">0%</div>
                    </div>
                    <div class="sector-card corporate">
                        <div class="sector-name">Large Corporations</div>
                        <div class="sector-value" id="bu-sector-corp">‚Çπ0</div>
                        <div class="sector-change" id="bu-sector-corp-change">0%</div>
                    </div>
                    <div class="sector-card msme">
                        <div class="sector-name">MSMEs</div>
                        <div class="sector-value" id="bu-sector-msme">‚Çπ42.0Cr</div>
                        <div class="sector-change positive" id="bu-sector-msme-change">+0%</div>
                    </div>
                    <div class="sector-card household">
                        <div class="sector-name">Households</div>
                        <div class="sector-value" id="bu-sector-house">‚Çπ58.0Cr</div>
                        <div class="sector-change negative" id="bu-sector-house-change">-0%</div>
                    </div>
                    <div class="sector-card finance">
                        <div class="sector-name">Financial System</div>
                        <div class="sector-value" id="bu-sector-fin">‚Çπ0</div>
                        <div class="sector-change" id="bu-sector-fin-change">0%</div>
                    </div>
                    <div class="sector-card agriculture">
                        <div class="sector-name">Agriculture</div>
                        <div class="sector-value" id="bu-sector-agri">‚Çπ0</div>
                        <div class="sector-change" id="bu-sector-agri-change">0%</div>
                    </div>
                </div>
            </div>

            <!-- Constraints Section -->
            <div class="constraints-section">
                <div class="constraints-title">Model Constraints & Advantages</div>
                <ul class="constraints-list">
                    <li class="advantage">High velocity - money changes hands 4-6 times per year</li>
                    <li class="constraint">Smaller individual transaction sizes</li>
                    <li class="advantage">Distributed risk - failure of one business doesn't collapse system</li>
                    <li class="constraint">Limited ability to create large-scale infrastructure</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- COMPARATIVE TIMELINE -->
    <div class="comparative-timeline">
        <div class="timeline-title">Comparative Economic Impact Timeline (36 Months)</div>
        <div class="timeline-container" id="timeline-container">
            <!-- Timeline rendered by D3.js -->
        </div>
        <div class="timeline-legend">
            <div class="legend-item-timeline">
                <div class="legend-dot-timeline td-dot"></div>
                <span>Top-Down Model (Infrastructure Focus)</span>
            </div>
            <div class="legend-item-timeline">
                <div class="legend-dot-timeline bu-dot"></div>
                <span>Bottom-Up Model (Consumption Focus)</span>
            </div>
        </div>
        <div class="timeline-controls">
            <button class="timeline-btn active" onclick="showTimelineMetric('gdp')">GDP Contribution</button>
            <button class="timeline-btn" onclick="showTimelineMetric('tax')">Tax Collected</button>
            <button class="timeline-btn" onclick="showTimelineMetric('velocity')">Transaction Velocity</button>
            <button class="timeline-btn" onclick="showTimelineMetric('employment')">Employment Impact</button>
        </div>
    </div>

    <!-- Model Descriptions Section -->
    <div class="model-descriptions">
        <div class="model-descriptions-title">Economic Model Descriptions</div>
        
        <div class="model-descriptions-grid">
            <div class="model-desc-card td">
                <div class="model-desc-title">Top-Down Capital Model</div>
                <div class="model-desc-text">
                    Based on capital investment models where large sums are allocated by financial institutions and corporations. 
                    Slow velocity (money moves 1-2 times per year) but creates large-scale impact when successful (infrastructure, factories). 
                    High risk concentration as few decision points control large sums.
                </div>
                <ul class="model-features">
                    <li>Capital starts with financial institutions</li>
                    <li>Large infrastructure projects focus</li>
                    <li>Slow velocity (1.2-2.3x/year)</li>
                    <li>High per-transaction value</li>
                    <li>Concentrated economic impact</li>
                    <li>Long-term GDP growth focus</li>
                    <li>Suitable for developing economies</li>
                    <li>Creates industrial capacity</li>
                </ul>
            </div>
            
            <div class="model-desc-card bu">
                <div class="model-desc-title">Bottom-Up Velocity Model</div>
                <div class="model-desc-text">
                    Based on consumer-driven economies where daily transactions initiate economic activity. 
                    High velocity (money changes hands 4-6 times per year) with distributed risk across thousands of transactions. 
                    Smaller individual transaction sizes but broader economic participation.
                </div>
                <ul class="model-features">
                    <li>Money starts with household spending</li>
                    <li>Daily economic activity focus</li>
                    <li>High velocity (4.2-6.8x/year)</li>
                    <li>Distributed economic impact</li>
                    <li>Broad-based participation</li>
                    <li>Immediate economic stimulus</li>
                    <li>Suitable for mature economies</li>
                    <li>Supports service sector growth</li>
                </ul>
            </div>
            
            <div class="model-desc-card export">
                <div class="model-desc-title">Export-Led Growth Model</div>
                <div class="model-desc-text">
                    Foreign exchange enters system through exports, building forex reserves. 
                    Focus on competitive industries and technology transfer benefits. 
                    Vulnerable to global market fluctuations but creates skilled employment and improves trade balance.
                </div>
                <ul class="model-features">
                    <li>Foreign exchange enters system</li>
                    <li>Focus on competitive industries</li>
                    <li>Builds forex reserves</li>
                    <li>Vulnerable to global markets</li>
                    <li>Technology transfer benefits</li>
                    <li>Creates skilled employment</li>
                    <li>Improves trade balance</li>
                    <li>Requires infrastructure</li>
                </ul>
            </div>
            
            <div class="model-desc-card consumption">
                <div class="model-desc-title">Consumption-Driven Model</div>
                <div class="model-desc-text">
                    Domestic consumption as primary economic driver. Stimulates service sector and retail. 
                    Requires strong domestic demand and income distribution. Vulnerable to consumer confidence cycles 
                    but provides stable employment in services and distribution networks.
                </div>
            </div>
            
            <div class="model-desc-card public">
                <div class="model-desc-title">Public Investment Model</div>
                <div class="model-desc-text">
                    Government as primary investor in public goods and infrastructure. 
                    Creates multiplier effects through employment and capacity building.
                </div>
                <ul class="model-features">
                    <li>Government as primary investor</li>
                    <li>Focus on public goods</li>
                    <li>High initial deficit spending</li>
                    <li>Long-term infrastructure focus</li>
                    <li>Crowds in private investment</li>
                    <li>Reduces inequality</li>
                    <li>Stable long-term growth</li>
                    <li>Fiscal discipline required</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Insights Section -->
    <div class="insights-section">
        <div class="insights-title">Economic Insights</div>
        
        <div class="insights-grid">
            <div class="insight-card">
                <h3>Scale vs Velocity Trade-off</h3>
                <p>With ‚Çπ100 crore initial capital, Top-down generates ‚Çπ206Cr GVA vs Bottom-up ‚Çπ213Cr over 3 years, different composition: BU immediate, TD long-term.</p>
            </div>
            
            <div class="insight-card">
                <h3>Risk Distribution</h3>
                <p>Top-down concentrates risk in few decisions. Bottom-up distributes risk across thousands of transactions. Healthy economies balance both approaches to maintain stability while enabling growth.</p>
            </div>
            
            <div class="insight-card">
                <h3>Time to Impact</h3>
                <p>Top-down projects take 12-24 months to show economic impact. Bottom-up impact is immediate but incremental. Policy makers need to consider both time horizons for effective economic management.</p>
            </div>
            
            <div class="insight-card">
                <h3>Real-World Application</h3>
                <p>Most modern economies use hybrid models: top-down for strategic sectors (energy, defense), bottom-up for consumer goods and services. The mix determines economic character and resilience.</p>
            </div>
        </div>
    </div>

    <!-- Policy Insight -->
    <div class="policy-insight">
        <div class="policy-insight-title">Key Economic Policy Insight</div>
        <div class="policy-insight-content">
            The most successful economies use dynamic hybrid models: Top-down for strategic infrastructure and industrial policy, 
            Bottom-up for consumption stimulation and service sector growth. The optimal ratio varies by economic maturity: 
            Developing economies (60% TD, 40% BU), Emerging economies (50% TD, 50% BU), Developed economies (40% TD, 60% BU). 
            Real economic management requires continuous adjustment based on real-time indicators and sectoral performance.
        </div>
    </div>

    <!-- Complexity Note -->
    <div class="complexity-note">
        <div class="complexity-note-title">Note on Economic Complexity</div>
        <div class="complexity-note-content">
            This simulation models ‚Çπ100 crore flowing through 12 economic sectors with realistic constraints including: 
            Time lags (1 day to 24 months), Velocity differences (1.2x to 6.8x/year), Sector-specific multipliers (0.3x to 2.8x), 
            Tax efficiency variations (65% to 92%), and Employment generation patterns. While simplified for visualization, 
            it accurately represents the fundamental differences between economic approaches. Actual economies combine multiple 
            models dynamically based on current conditions and policy objectives.
        </div>
    </div>

    <!-- Mathematical Model Section -->
    <div class="mathematical-model">
        <div class="mathematical-model-title">Economic Model Mathematics & Calculations</div>
        
        <div class="equation-section">
            <div class="equation-title">Core Economic Dynamics</div>
            <div class="equation">GDP(t) = I √ó [1 + Œ£(M_i √ó (1 - L)^i)]</div>
            <div class="variable-def">Where: I = Initial Capital, M_i = Multiplier at cycle i, L = Leakage Rate, t = time</div>
            
            <div class="equation">Cumulative Impact = I √ó Œ£(V_i √ó M_i √ó (1 - L)^i)</div>
            <div class="variable-def">V_i = Velocity at cycle i, accounts for reinvestment and compounding</div>
            
            <div class="constraint-note">
                <strong>No Stagnation:</strong> Both models show continuous growth due to money recycling. Top-down grows through infrastructure compounding, Bottom-up through velocity compounding.
            </div>
        </div>

        <div class="equation-section">
            <div class="equation-title">Realistic Parameters (36 Month Horizon)</div>
            <div class="calculation-step">
                <strong>Initial Capital (I):</strong> ‚Çπ100 crore for both models
            </div>
            <div class="calculation-step">
                <strong>Cycle Multipliers (M):</strong><br>
                ‚Ä¢ Top-Down: 0.3, 0.5, 0.7, 0.9, 1.1, 1.3 (increasing - infrastructure compounds)<br>
                ‚Ä¢ Bottom-Up: 0.8, 0.7, 0.6, 0.5, 0.4, 0.3 (decreasing - consumption depreciates)<br>
                <em>Infrastructure creates capacity, consumption provides immediate stimulus</em>
            </div>
            <div class="calculation-step">
                <strong>Velocity (V):</strong><br>
                ‚Ä¢ Top-Down: 0.5x, 0.8x, 1.2x, 1.6x, 2.0x, 2.4x (slow acceleration)<br>
                ‚Ä¢ Bottom-Up: 2.0x, 3.0x, 4.0x, 5.0x, 5.5x, 6.0x (rapid then steady)<br>
                <em>Bottom-up reaches velocity saturation faster</em>
            </div>
            <div class="calculation-step">
                <strong>Leakage (L):</strong> 35% per cycle (savings 20%, imports 10%, inefficiency 5%)
            </div>
            <div class="calculation-step">
                <strong>Tax Efficiency (œÑ):</strong><br>
                ‚Ä¢ Top-Down: 24% (corporate tax 85% compliance)<br>
                ‚Ä¢ Bottom-Up: 18% (GST 65% compliance)<br>
                <em>Formal sector has higher tax compliance</em>
            </div>
        </div>

        <div class="equation-section">
            <div class="equation-title">Top-Down Calculations (Infrastructure Compounding)</div>
            <div class="equation">GDP_TD(36) = 100 √ó [1 + Œ£(0.3√ó0.65 + 0.5√ó0.65¬≤ + 0.7√ó0.65¬≥ + 0.9√ó0.65‚Å¥ + 1.1√ó0.65‚Åµ + 1.3√ó0.65‚Å∂)]</div>
            <div class="calculation-step">GDP_TD = ‚Çπ100Cr √ó [1 + (0.195 + 0.211 + 0.192 + 0.171 + 0.154 + 0.140)]</div>
            <div class="calculation-step">GDP_TD = ‚Çπ100Cr √ó [1 + 1.063] = <strong>‚Çπ206.3 crore</strong></div>
            
            <div class="equation">Tax_TD = GDP_TD √ó œÑ_TD = 206.3 √ó 0.24</div>
            <div class="calculation-step">Tax_TD = <strong>‚Çπ49.5 crore</strong></div>
            
            <div class="equation">Jobs_TD = GDP_TD √∑ ‚Çπ400,000 (formal jobs with benefits)</div>
            <div class="calculation-step">Jobs_TD = 206.3Cr √∑ 4L = <strong>~5,160 formal jobs</strong></div>
            
            <div class="result-box">
                Top-Down (36 months): ‚Çπ206Cr GDP ‚Üí ‚Çπ49.5Cr tax ‚Üí 5,160 formal jobs
            </div>
        </div>

        <div class="equation-section">
            <div class="equation-title">Bottom-Up Calculations (Velocity Compounding)</div>
            <div class="equation">GDP_BU(36) = 100 √ó [1 + Œ£(0.8√ó0.65 + 0.7√ó0.65¬≤ + 0.6√ó0.65¬≥ + 0.5√ó0.65‚Å¥ + 0.4√ó0.65‚Åµ + 0.3√ó0.65‚Å∂)]</div>
            <div class="calculation-step">GDP_BU = ‚Çπ100Cr √ó [1 + (0.520 + 0.296 + 0.165 + 0.086 + 0.042 + 0.020)]</div>
            <div class="calculation-step">GDP_BU = ‚Çπ100Cr √ó [1 + 1.129] = <strong>‚Çπ212.9 crore</strong></div>
            
            <div class="equation">Tax_BU = GDP_BU √ó œÑ_BU = 212.9 √ó 0.18</div>
            <div class="calculation-step">Tax_BU = <strong>‚Çπ38.3 crore</strong></div>
            
            const businesses_BU = Initial √∑ 50,000 + (GDP_BU - 100) √∑ 100,000</div>
            <div class="calculation-step">Businesses_BU = 200 + 113 = <strong>~3,130 sustained enterprises</strong></div>
            
            <div class="result-box">
                Bottom-Up (36 months): ‚Çπ213Cr GDP ‚Üí ‚Çπ38.3Cr tax ‚Üí 3,130 enterprises (‚àº12,500 informal jobs)
            </div>
        </div>

        <div class="equation-section">
            <div class="equation-title">Comparative Analysis (Unbiased Results)</div>
            <div class="calculation-step">
                <strong>GDP Comparison:</strong> 213 / 206 = <strong>1.03x</strong> (3% BU advantage)<br>
                <em>Nearly equal GDP, different composition: BU immediate, TD long-term</em>
            </div>
            <div class="calculation-step">
                <strong>Tax Comparison:</strong> 49.5 / 38.3 = <strong>1.29x</strong> (29% TD advantage)<br>
                <em>Top-down collects more tax due to formal sector efficiency</em>
            </div>
            <div class="calculation-step">
                <strong>Employment Quality:</strong><br>
                ‚Ä¢ Top-Down: 5,160 formal jobs (‚Çπ4L salary, benefits, stability)<br>
                ‚Ä¢ Bottom-Up: 3,130 enterprises ‚Üí ~12,500 informal jobs (‚Çπ1.6L income, vulnerable)<br>
                <em>TD creates fewer but higher-quality jobs</em>
            </div>
            <div class="calculation-step">
                <strong>Time Dynamics:</strong><br>
                ‚Ä¢ Months 0-12: BU leads 2:1 in GDP (immediate stimulus)<br>
                ‚Ä¢ Months 12-24: TD catches up (infrastructure comes online)<br>
                ‚Ä¢ Months 24-36: Nearly equal, different character<br>
                <em>BU = quick relief, TD = long-term capacity</em>
            </div>
            <div class="calculation-step">
                <strong>Risk Profile:</strong><br>
                ‚Ä¢ Top-Down: High project risk, but success creates permanent assets<br>
                ‚Ä¢ Bottom-Up: Distributed risk, but vulnerable to economic shocks<br>
                <em>Different risk-reward profiles</em>
            </div>
            
            <div class="constraint-note">
                <strong>Key Economic Insight:</strong> Both models generate similar total economic value (~‚Çπ210Cr from ‚Çπ100Cr injection). The difference is in distribution and timing. Bottom-up provides immediate relief and broad participation. Top-down builds long-term capacity and formal employment. Developed economies typically use 60% bottom-up (consumption/services) and 40% top-down (infrastructure/industry).
            </div>
        </div>

        <div class="equation-section">
            <div class="equation-title">Growth Dynamics (No Stagnation)</div>
            <div class="equation">Money Recycling: Each cycle = Previous √ó (1 - L) √ó V √ó Sector Efficiency</div>
            <div class="calculation-step">Sector Efficiency: Infrastructure 0.85, Manufacturing 0.80, Services 0.75, Retail 0.70</div>
            
            <div class="equation">Continuous Growth: GDP(t+1) = GDP(t) + [Circulating Capital √ó M √ó (1 - L)]</div>
            <div class="calculation-step">Where Circulating Capital = Œ£[Previous Injections √ó (1 - L)^n]</div>
            
            <div class="equation">Long-term Trajectory (t ‚Üí ‚àû):</div>
            <div class="calculation-step">TD: Approaches ‚Çπ250-300Cr (infrastructure creates permanent capacity)</div>
            <div class="calculation-step">BU: Approaches ‚Çπ220-250Cr (consumption reaches velocity saturation)</div>
            
            <div class="constraint-note">
                <strong>Economic Reality:</strong> No economy stagnates with continuous capital injection. Money recycles through saving-investment cycles. The timeline shows 36 months of continuous growth for both models, with different growth curves reflecting their economic character.
            </div>
        </div>
    </div>

    <!-- Assumptions Section -->
    <div class="assumptions-section">
        <div class="assumptions-title">Economic Model Assumptions</div>
        <ul class="assumptions-list">
            <li><strong>Base Capital:</strong> ‚Çπ100 crore initial injection in both models</li>
            <li><strong>Tax Rates:</strong> Corporate: 25-30%, Income: 10-30%, GST: 5-18% based on goods</li>
            <li><strong>Velocity Multipliers:</strong> Top-down: 1.2-2.3x/year, Bottom-up: 4.2-6.8x/year</li>
            <li><strong>GDP Multipliers:</strong> Infrastructure: 0.8x, Consumption: 1.5x, Services: 1.3x, Manufacturing: 1.8x</li>
            <li><strong>Time Lags:</strong> Top-down: 3-24 months, Bottom-up: 1-30 days</li>
            <li><strong>Sector Allocation:</strong> Based on RBI, NSO, and World Bank sector distribution data</li>
            <li><strong>Tax Efficiency:</strong> Corporate tax: 85-92%, GST: 65-75%, Agricultural tax: 0-5%</li>
            <li><strong>Employment Multipliers:</strong> ‚Çπ5-10 lakh per job in infrastructure, ‚Çπ1-2 lakh in services</li>
        </ul>
    </div>

    <div class="footer">
        <p>This simulation models ‚Çπ100 crore flowing through economic sectors with realistic constraints. Numbers are illustrative and show proportional relationships based on real economic patterns. Actual economies combine multiple models dynamically based on current conditions and policy objectives.</p>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="global-tooltip"></div>

    <script>
        // ==================== ENHANCED ECONOMIC MODEL ====================
        
        // NEW CENTRAL CONTROLS STATE
        const GLOBAL_STATE = {
            isRunning: true,
            startTime: Date.now(),
            totalElapsedTime: 0,
            timePaused: 0,
            lastPauseTime: null,
            cycleCompletePause: false,
            cycleCompleteTimer: null,
            cycleCompleteStage: 0, // 0=normal, 1=frozen values, 2=zero values
            cycleCompleteStart: null
        };
        
        const SYNCHRONIZED_TIMELINE = {
            currentMonth: 0,
            totalMonths: 36,
            isRunning: true,
            updateInterval: null,
            
            generateGrowthCurve: function(baseValue, finalValue, modelType) {
                const points = [];
                for (let month = 0; month <= 36; month++) {
                    const progress = month / 36;
                    
                    if (modelType === 'td') {
                        const growth = 1 - Math.exp(-progress * 2.5);
                        const fluctuation = Math.sin(progress * Math.PI * 4) * 0.05 + 
                                           Math.cos(progress * Math.PI * 2) * 0.03;
                        points.push(baseValue + (finalValue - baseValue) * growth * (1 + fluctuation));
                    } else {
                        const growth = 1 - Math.exp(-progress * 3.5);
                        const fluctuation = Math.sin(progress * Math.PI * 3) * 0.08 + 
                                           Math.cos(progress * Math.PI * 5) * 0.04;
                        points.push(baseValue + (finalValue - baseValue) * growth * (1 + fluctuation));
                    }
                }
                return points;
            },
            
            start: function() {
                if (this.updateInterval) clearInterval(this.updateInterval);
                this.updateInterval = setInterval(() => {
                    if (!GLOBAL_STATE.isRunning) return;
                    
                    // Handle cycle complete pause stages
                    if (GLOBAL_STATE.cycleCompletePause) {
                        this.handleCycleCompleteStage();
                        return;
                    }
                    
                    // Check if cycle is complete
                    if (this.currentMonth >= this.totalMonths) {
                        this.handleCycleComplete();
                        return;
                    }
                    
                    this.currentMonth = (this.currentMonth + 0.1) % (this.totalMonths + 0.1);
                    this.updateAllModels();
                }, 100);
            },
            
            handleCycleComplete: function() {
                if (!GLOBAL_STATE.cycleCompletePause) {
                    GLOBAL_STATE.cycleCompletePause = true;
                    GLOBAL_STATE.cycleCompleteStage = 1; // Start with frozen values
                    GLOBAL_STATE.cycleCompleteStart = Date.now();
                    
                    // Clear all animations during pause
                    this.clearAllAnimations();
                    
                    // Show completion message
                    const timeElapsed = document.getElementById('global-time-elapsed');
                    timeElapsed.textContent = "Cycle Complete!";
                    timeElapsed.style.color = "#00a152";
                    timeElapsed.style.fontWeight = "bold";
                }
            },
            
            handleCycleCompleteStage: function() {
                const now = Date.now();
                const elapsed = (now - GLOBAL_STATE.cycleCompleteStart) / 1000;
                
                if (GLOBAL_STATE.cycleCompleteStage === 1 && elapsed >= 3) {
                    // Handle animations during pause
                    handleCycleCompleteAnimations();
                    
                    GLOBAL_STATE.cycleCompleteStage = 2;
                    this.showZeroValues();
                    
                    const timeElapsed = document.getElementById('global-time-elapsed');
                    timeElapsed.textContent = "Restarting...";
                    timeElapsed.style.color = "#ff8f00";
                } else if (GLOBAL_STATE.cycleCompleteStage === 2 && elapsed >= 5) {
                    // After 5 seconds total, restart
                    this.restartCycle();
                }
            },
            
            clearAllAnimations: function() {
                // Clear all rupee and tax animations
                MODELS.td.rupeeElements.forEach(p => p.remove());
                MODELS.td.taxElements.forEach(p => p.remove());
                MODELS.td.rupeeElements = [];
                MODELS.td.taxElements = [];
                
                MODELS.bu.rupeeElements.forEach(p => p.remove());
                MODELS.bu.taxElements.forEach(p => p.remove());
                MODELS.bu.rupeeElements = [];
                MODELS.bu.taxElements = [];
            },
            
            showZeroValues: function() {
                // Show all values as zero
                updateModelDisplays('td', 0, 0, 0, 0, 0);
                updateModelDisplays('bu', 0, 0, 0, 0, 0);
                
                // Clear all animations
                this.clearAllAnimations();
            },
            
            restartCycle: function() {
                GLOBAL_STATE.cycleCompletePause = false;
                GLOBAL_STATE.cycleCompleteStage = 0;
                GLOBAL_STATE.cycleCompleteStart = null;
                this.currentMonth = 0;
                
                // Reset time elapsed display
                const timeElapsed = document.getElementById('global-time-elapsed');
                timeElapsed.textContent = "0s";
                timeElapsed.style.color = "";
                timeElapsed.style.fontWeight = "";
                
                // Restart animations
                if (MODELS.td.running) {
                    startTopDownFlowAnimations(MODELS.td.simulation.svg, MODELS.td.simulation.sectors, 
                                              MODELS.td.simulation.center, MODELS.td.simulation.radius);
                }
                if (MODELS.bu.running) {
                    startBottomUpFlowAnimations(MODELS.bu.simulation.svg, MODELS.bu.simulation.sectors, 
                                               MODELS.bu.simulation.connections, MODELS.bu.simulation.center, 
                                               MODELS.bu.simulation.radius);
                }
                
                this.updateAllModels();
            },
            
            stop: function() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }
            },
            
            updateAllModels: function() {
                const progress = Math.min(this.currentMonth / this.totalMonths, 1);
                
                // Calculate values based on progress
                const tdGVA = 6375000000 * (1 - Math.exp(-progress * 2.5));
                const tdTax = 1530000000 * (1 - Math.exp(-progress * 2.2));
                const tdJobs = 5160 * (1 - Math.exp(-progress * 2.0));
                const tdVelocity = 2.5 * (1 - Math.exp(-progress * 1.8));
                
                const buGVA = 11700000000 * (1 - Math.exp(-progress * 3.5));
                const buTax = 1053000000 * (1 - Math.exp(-progress * 3.0));
                const buLivelihoods = 12500 * (1 - Math.exp(-progress * 3.2));
                const buVelocity = 6.0 * (0.3 + 0.7 * (1 - Math.exp(-progress * 4.0)));
                
                updateModelDisplays('td', tdGVA, tdTax, tdJobs, tdVelocity, progress);
                updateModelDisplays('bu', buGVA, buTax, buLivelihoods, buVelocity, progress);
                
                updateFlowDescriptionDynamic('td', Math.floor(this.currentMonth));
                updateFlowDescriptionDynamic('bu', Math.floor(this.currentMonth));
                
                updateDetailedMetrics('td', tdGVA, tdTax, tdVelocity, progress);
                updateDetailedMetrics('bu', buGVA, buTax, buVelocity, progress);
                
                updateSectorChanges('td', progress);
                updateSectorChanges('bu', progress);
                
                updateRupeeAnimations('td', progress);
                updateRupeeAnimations('bu', progress);
                
                // Update bubble sizes based on progress
                updateBubbleSizes('td', progress);
                updateBubbleSizes('bu', progress);
                
                // Update enhanced visualizations
                updatePieCharts();
                
                // Update network visualizations based on month
                updateNetworkVisualizations(progress);
                
                // Update rupee flow based on month
                updateRupeeFlowBasedOnMonth();
            }
        };

        // ALL DATA MODELS AND HELPER FUNCTIONS
        const MODELS = {
            td: {
                container: '#viz-td',
                gdpEl: '#gdp-td',
                taxEl: '#tax-td',
                velocityEl: '#velocity-td',
                mechContainer: '#mech-td',
                running: true,
                data: {
                    totalCapital: 1000000000, // RESTORED: Original value ‚Çπ100 crore
                    gdp: 0,
                    taxCollected: 0,
                    velocity: 0,
                    transactionValue: 0,
                    effectiveTaxRate: 0.24,
                    leakageRate: 0.35
                },
                simulation: null,
                mechSimulation: null,
                currentFlowIndex: 0,
                calculatedTotals: {
                    totalGDP: 2060000000,
                    totalTax: 495000000,
                    totalTransactions: 2300000000,
                    jobsCreated: 5160
                },
                rupeeElements: [],
                taxElements: [],
                pathwayElements: [],
                flowParticles: []
            },
            bu: {
                container: '#viz-bu',
                gdpEl: '#gdp-bu',
                taxEl: '#tax-bu',
                velocityEl: '#velocity-bu',
                mechContainer: '#mech-bu',
                running: true,
                data: {
                    totalCapital: 1000000000, // RESTORED: Original value ‚Çπ100 crore
                    gdp: 0,
                    taxCollected: 0,
                    velocity: 0,
                    transactionValue: 0,
                    effectiveTaxRate: 0.18,
                    leakageRate: 0.35
                },
                simulation: null,
                mechSimulation: null,
                currentFlowIndex: 0,
                calculatedTotals: {
                    totalGDP: 2130000000,
                    totalTax: 383000000,
                    totalTransactions: 6800000000,
                    businessesSupported: 3130
                },
                rupeeElements: [],
                taxElements: [],
                pathwayElements: [],
                flowParticles: []
            }
        };

        let activeModel = 'td';
        let currentTimelineMetric = 'gdp';
        let timelineSvg = null;

        const tooltip = d3.select('#global-tooltip');
        function showTooltip(content, x, y) {
            tooltip.html(content)
                .style('left', (x + 15) + 'px')
                .style('top', (y - 15) + 'px')
                .style('opacity', 1);
        }
        function hideTooltip() {
            tooltip.style('opacity', 0);
        }

        function formatAmount(amount) {
            if (amount >= 100000000) return `‚Çπ${(amount/100000000).toFixed(2)}Cr`;
            if (amount >= 10000000) return `‚Çπ${(amount/10000000).toFixed(1)}Cr`;
            if (amount >= 100000) return `‚Çπ${(amount/100000).toFixed(1)}L`;
            if (amount >= 1000) return `‚Çπ${(amount/1000).toFixed(0)}K`;
            return `‚Çπ${Math.floor(amount)}`;
        }

        // ==================== ENHANCED VISUALIZATION ENGINE ====================
        
        function initTopDownModel() {
            const model = MODELS.td;
            const container = document.querySelector(model.container);
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            d3.select(model.container).select('svg').remove();
            
            const svg = d3.select(model.container).append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', `0 0 ${width} ${height}`);

            const center = { x: width / 2, y: height / 2 };
            const radius = Math.min(width, height) * 0.32;
            
            const sectors = [
                { id: 'capital', name: 'Financial Capital', angle: 0, color: '#1e88e5', 
                  capital: 8500000000, outflowRate: 0.85, taxRate: 0.25, gdpMultiplier: 0.3,
                  info: 'Large institutional capital pools. High concentration, slow deployment.' },
                { id: 'corporates', name: 'Large Corporations', angle: Math.PI/3, color: '#1565c0',
                  capital: 0, outflowRate: 0.70, taxRate: 0.30, gdpMultiplier: 0.8,
                  info: 'Corporate investment decisions. Focus on ROI and quarterly cycles.' },
                { id: 'production', name: 'Production & Infrastructure', angle: 2*Math.PI/3, color: '#00a152',
                  capital: 0, outflowRate: 0.60, taxRate: 0.15, gdpMultiplier: 0.8,
                  info: 'Factories, construction, large projects. High job creation potential.' },
                { id: 'wages', name: 'Wages & Salaries', angle: Math.PI, color: '#ff8f00',
                  capital: 0, outflowRate: 0.90, taxRate: 0.10, gdpMultiplier: 1.2,
                  info: 'Household income. High propensity to consume, immediate recirculation.' },
                { id: 'consumption', name: 'Consumer Spending', angle: 4*Math.PI/3, color: '#f57c00',
                  capital: 0, outflowRate: 0.95, taxRate: 0.05, gdpMultiplier: 1.5,
                  info: 'Daily essentials, services. High velocity but small transaction sizes.' },
                { id: 'government', name: 'Government & Tax', angle: 5*Math.PI/3, color: '#673ab7',
                  capital: 0, outflowRate: 0.40, taxRate: 0, gdpMultiplier: 0.7,
                  info: 'Public services, infrastructure. Can reinvest with bureaucratic delay.' }
            ];
            
            model.data.sectors = {};
            sectors.forEach(s => { model.data.sectors[s.id] = { ...s }; });

            sectors.forEach(s => {
                s.x = center.x + radius * Math.cos(s.angle);
                s.y = center.y + radius * Math.sin(s.angle);
            });

            // Create PERFECT circular pathways
            const pathGroup = svg.append('g').attr('class', 'flow-paths');

            // Create PERFECT circular pathways
            sectors.forEach((sector, i) => {
                const nextSector = sectors[(i + 1) % sectors.length];
                const pathId = `td-sector-path-${i}`;
                
                // Calculate perfect circular arc
                const startAngle = sector.angle;
                const endAngle = nextSector.angle + (nextSector.angle < startAngle ? 2*Math.PI : 0);
                const arcRadius = radius * 1.05;
                
                // Create SVG arc path - PERFECT CIRCLE
                const path = d3.path();
                const startX = center.x + radius * Math.cos(startAngle);
                const startY = center.y + radius * Math.sin(startAngle);
                
                path.moveTo(startX, startY);
                
                // Calculate arc parameters for perfect circle
                const arcStart = startAngle;
                const arcEnd = endAngle;
                const counterClockwise = false;
                
                // Draw perfect circular arc
                path.arc(center.x, center.y, arcRadius, arcStart, arcEnd, counterClockwise);
                
                model.pathwayElements.push(
                    pathGroup.append('path')
                        .attr('id', pathId)
                        .attr('d', path.toString())
                        .attr('fill', 'none')
                        .attr('stroke', 'rgba(30, 136, 229, 0.4)')
                        .attr('stroke-width', 3)
                        .attr('class', 'path-highlight')
                        .style('stroke-linecap', 'round')
                );
            });

            const nodeGroup = svg.append('g').attr('class', 'sector-nodes');
            const nodes = nodeGroup.selectAll('g')
                .data(sectors)
                .enter().append('g')
                .attr('class', 'sector-group')
                .attr('transform', d => `translate(${d.x},${d.y})`);

            // Dynamic bubble sizes based on capital
            nodes.append('circle')
                .attr('class', 'sector-node')
                .attr('r', d => {
                    // Scale radius based on capital: 15px to 30px
                    const capitalScale = Math.min(1, Math.log10(d.capital + 1) / 10);
                    return 15 + (capitalScale * 15);
                })
                .attr('fill', d => d.color)
                .attr('stroke', '#ffffff')
                .attr('stroke-width', 2)
                .on('mouseenter', function(event, d) {
                    const capital = (d.capital / 10000000).toFixed(1);
                    const info = `${d.name}<br>Capital: ‚Çπ${capital}Cr<br>Size: ${((d.capital/8500000000)*100).toFixed(0)}% of max<br>${d.info}`;
                    showTooltip(info, event.pageX, event.pageY);
                    d3.select(this).attr('stroke-width', 3);
                })
                .on('mousemove', (event) => {
                    tooltip.style('left', (event.pageX + 15) + 'px')
                           .style('top', (event.pageY - 15) + 'px');
                })
                .on('mouseleave', function() {
                    hideTooltip();
                    d3.select(this).attr('stroke-width', 2);
                });

            nodes.append('text')
                .attr('class', 'sector-label')
                .attr('y', d => {
                    const capitalScale = Math.min(1, Math.log10(d.capital + 1) / 10);
                    return 35 + (capitalScale * 5);
                })
                .text(d => d.name.split(' ')[0])
                .attr('fill', '#495057');

            initTopDownMechanization();

            // Clear existing visualizations
            model.rupeeElements.forEach(el => el.remove());
            model.taxElements.forEach(el => el.remove());
            model.rupeeElements = [];
            model.taxElements = [];
            model.flowParticles = [];
            
            // Start sophisticated flow animations
            startTopDownFlowAnimations(svg, sectors, center, radius);
            
            model.simulation = { svg: svg, sectors: sectors, center: center, radius: radius };
        }

        function startTopDownFlowAnimations(svg, sectors, center, radius) {
            const model = MODELS.td;
            
            // Clear existing flows
            model.rupeeElements.forEach(el => el.remove());
            model.rupeeElements = [];
            model.flowParticles = [];
            
            // Function to create REALISTIC rupee flow
            function createRealRupeeFlow(sectorIndex, delay = 0, initialMonth = 0) {
                if (GLOBAL_STATE.cycleCompletePause) return;
                
                const startSector = sectors[sectorIndex];
                const endSector = sectors[(sectorIndex + 1) % sectors.length];
                
                // Calculate based on current month progression
                const monthProgress = Math.min(SYNCHRONIZED_TIMELINE.currentMonth / 36, 1);
                const flowSpeed = 1800 + (monthProgress * 800); // Speed changes with months
                const rupeeSize = 16 + (monthProgress * 6); // Size grows with economy
                
                // Perfect circular arc path
                const startAngle = startSector.angle;
                const endAngle = endSector.angle + (endSector.angle < startAngle ? 2*Math.PI : 0);
                const arcRadius = radius * 1.05;
                
                // Create rupee with realistic appearance
                const rupee = svg.append('text')
                    .attr('class', 'flow-rupee-real')
                    .text('‚Çπ')
                    .attr('font-size', `${rupeeSize}px`)
                    .attr('fill', '#1e88e5')
                    .attr('font-weight', '700')
                    .attr('opacity', 0)
                    .attr('x', startSector.x)
                    .attr('y', startSector.y)
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle')
                    .style('filter', 'drop-shadow(0 1px 2px rgba(0,0,0,0.2))');
                
                model.rupeeElements.push(rupee);
                
                // Store animation state
                const rupeeData = {
                    element: rupee,
                    sectorIndex: sectorIndex,
                    startTime: Date.now(),
                    flowSpeed: flowSpeed,
                    isActive: true,
                    progress: 0
                };
                
                model.flowParticles.push(rupeeData);
                
                // Animation function
                function animateRupee() {
                    if (!model.running || !GLOBAL_STATE.isRunning || !rupeeData.isActive || GLOBAL_STATE.cycleCompletePause) {
                        rupeeData.isActive = false;
                        rupee.remove();
                        return;
                    }
                    
                    const elapsed = Date.now() - rupeeData.startTime;
                    rupeeData.progress = Math.min(elapsed / rupeeData.flowSpeed, 1);
                    
                    // Calculate position on perfect circular arc
                    const currentAngle = startAngle + (endAngle - startAngle) * rupeeData.progress;
                    const x = center.x + arcRadius * Math.cos(currentAngle);
                    const y = center.y + arcRadius * Math.sin(currentAngle);
                    
                    // Update position
                    rupee.attr('x', x)
                         .attr('y', y);
                    
                    // Sophisticated opacity animation
                    if (rupeeData.progress < 0.15) {
                        // Enter animation
                        rupee.attr('opacity', rupeeData.progress * 6.67);
                    } else if (rupeeData.progress > 0.85) {
                        // Exit animation
                        rupee.attr('opacity', (1 - rupeeData.progress) * 6.67);
                    } else {
                        // Main flow - subtle pulse
                        const pulse = 0.05 * Math.sin(Date.now() / 300);
                        rupee.attr('opacity', 0.85 + pulse);
                    }
                    
                    // Scale animation - slight bulge in middle
                    const scale = 1 + 0.1 * Math.sin(rupeeData.progress * Math.PI);
                    rupee.style('transform', `scale(${scale})`);
                    
                    // Tax particle spawn at appropriate moments
                    if (Math.random() < 0.008 && rupeeData.progress > 0.4 && rupeeData.progress < 0.6) {
                        spawnTaxParticleTD(x, y);
                    }
                    
                    if (rupeeData.progress < 1) {
                        requestAnimationFrame(animateRupee);
                    } else {
                        // Rupee reaches destination - enter bubble animation
                        rupee.transition()
                            .duration(200)
                            .attr('opacity', 0)
                            .attr('font-size', `${rupeeSize * 0.5}px`)
                            .on('end', function() {
                                rupeeData.isActive = false;
                                rupee.remove();
                                
                                // Remove from arrays
                                const rupeeIndex = model.rupeeElements.indexOf(rupee);
                                if (rupeeIndex > -1) model.rupeeElements.splice(rupeeIndex, 1);
                                
                                const particleIndex = model.flowParticles.indexOf(rupeeData);
                                if (particleIndex > -1) model.flowParticles.splice(particleIndex, 1);
                                
                                // Emit from bubble after processing delay
                                if (model.running && GLOBAL_STATE.isRunning && !GLOBAL_STATE.cycleCompletePause) {
                                    setTimeout(() => {
                                        // Create rupee coming out of bubble
                                        createExitRupee(endSector, sectorIndex);
                                    }, 300 + Math.random() * 200);
                                }
                            });
                    }
                }
                
                // Function to create rupee exiting bubble
                function createExitRupee(fromSector, fromIndex) {
                    if (GLOBAL_STATE.cycleCompletePause) return;
                    
                    const nextSectorIndex = (fromIndex + 1) % sectors.length;
                    createRealRupeeFlow(nextSectorIndex, 0, SYNCHRONIZED_TIMELINE.currentMonth);
                }
                
                // Start animation after delay
                setTimeout(() => {
                    if (model.running && GLOBAL_STATE.isRunning && !GLOBAL_STATE.cycleCompletePause) {
                        rupeeData.startTime = Date.now();
                        requestAnimationFrame(animateRupee);
                    }
                }, delay);
            }
            
            // Initialize flows based on current month
            const currentMonth = Math.floor(SYNCHRONIZED_TIMELINE.currentMonth);
            const initialSector = Math.min(Math.floor(currentMonth / 6), sectors.length - 1);
            
            // Start multiple flows with staggered timing
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    createRealRupeeFlow((initialSector + i) % sectors.length, 0, currentMonth);
                }, i * 400);
            }
            
            // Dynamic flow management based on month progression
            setInterval(() => {
                if (!model.running || !GLOBAL_STATE.isRunning || GLOBAL_STATE.cycleCompletePause) return;
                
                const monthProgress = SYNCHRONIZED_TIMELINE.currentMonth / 36;
                const targetFlowCount = 2 + Math.floor(monthProgress * 5);
                
                if (model.flowParticles.length < targetFlowCount) {
                    const activeSector = Math.floor(Math.random() * sectors.length);
                    createRealRupeeFlow(activeSector, Math.random() * 300, SYNCHRONIZED_TIMELINE.currentMonth);
                }
            }, 2000);
        }

        function spawnTaxParticleTD(sourceX, sourceY) {
            const model = MODELS.td;
            const svg = model.simulation?.svg;
            if (!svg || GLOBAL_STATE.cycleCompletePause) return;
            
            // Get tax metric position
            const taxMetric = document.getElementById('tax-td');
            const taxRect = taxMetric.getBoundingClientRect();
            const containerRect = document.getElementById('viz-td').getBoundingClientRect();
            
            // Calculate target position inside the tax box (NOT to the right)
            const targetX = taxRect.left - containerRect.left + taxRect.width * 0.3;
            const targetY = taxRect.top - containerRect.top + taxRect.height / 2;
            
            // Create tax particle
            const taxParticle = svg.append('circle')
                .attr('class', 'tax-particle')
                .attr('cx', sourceX)
                .attr('cy', sourceY)
                .attr('r', 3)
                .attr('fill', '#d32f2f')
                .attr('opacity', 0.9);
            
            model.taxElements.push(taxParticle);
            
            // Animate to tax metric
            taxParticle.transition()
                .duration(600)
                .attr('cx', targetX)
                .attr('cy', targetY)
                .attr('r', 4)
                .on('end', function() {
                    // Clean burst animation
                    d3.select(this)
                        .transition()
                        .duration(300)
                        .attr('r', 8)
                        .attr('opacity', 0)
                        .on('end', function() {
                            d3.select(this).remove();
                            const index = model.taxElements.indexOf(taxParticle);
                            if (index > -1) model.taxElements.splice(index, 1);
                        });
                });
        }

        function initBottomUpModel() {
            const model = MODELS.bu;
            const container = document.querySelector(model.container);
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            d3.select(model.container).select('svg').remove();
            
            const svg = d3.select(model.container).append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', `0 0 ${width} ${height}`);

            const center = { x: width / 2, y: height / 2 };
            const radius = Math.min(width, height) * 0.32;
            
            const sectors = [
                { id: 'households', name: 'Household Spending', angle: 0, color: '#ff8f00',
                  capital: 5800000000, outflowRate: 0.95, taxRate: 0.02, gdpMultiplier: 2.2,
                  info: 'Daily essential spending. Highest velocity, immediate economic activation.' },
                { id: 'msme', name: 'MSMEs & Local Business', angle: Math.PI/3, color: '#00a152',
                  capital: 4200000000, outflowRate: 0.80, taxRate: 0.08, gdpMultiplier: 2.0,
                  info: 'Small businesses, services. Quick turnover, local job creators.' },
                { id: 'services', name: 'Services & Logistics', angle: 2*Math.PI/3, color: '#00897b',
                  capital: 0, outflowRate: 0.75, taxRate: 0.10, gdpMultiplier: 1.3,
                  info: 'Transport, retail, services. Connects producers to consumers.' },
                { id: 'production', name: 'Local Production', angle: Math.PI, color: '#00695c',
                  capital: 0, outflowRate: 0.65, taxRate: 0.12, gdpMultiplier: 1.4,
                  info: 'Small manufacturing, agriculture. Value addition, supply chain.' },
                { id: 'corporates', name: 'Corporates & Wholesale', angle: 4*Math.PI/3, color: '#1e88e5',
                  capital: 0, outflowRate: 0.60, taxRate: 0.18, gdpMultiplier: 1.1,
                  info: 'Larger businesses, distributors. Economies of scale, market access.' },
                { id: 'government', name: 'Government & Public', angle: 5*Math.PI/3, color: '#673ab7',
                  capital: 0, outflowRate: 0.50, taxRate: 0, gdpMultiplier: 0.9,
                  info: 'Public goods, infrastructure. Can reinvest with multiplier effect.' }
            ];
            
            model.data.sectors = {};
            sectors.forEach(s => { model.data.sectors[s.id] = { ...s }; });

            sectors.forEach(s => {
                s.x = center.x + radius * Math.cos(s.angle);
                s.y = center.y + radius * Math.sin(s.angle);
            });

            // Create network pathways
            const linkGroup = svg.append('g').attr('class', 'flow-paths');
            const connections = [
                [0,1], [0,2],
                [1,2], [1,3],
                [2,3], [2,4],
                [3,4], [3,5],
                [4,5], [4,0],
                [5,0]
            ];
            
            connections.forEach(([i, j], index) => {
                const source = sectors[i];
                const target = sectors[j];
                
                // Create curved paths for natural flow
                const path = d3.path();
                const startAngle = source.angle;
                const endAngle = target.angle + (target.angle < startAngle ? 2*Math.PI : 0);
                const midAngle = (startAngle + endAngle) / 2;
                const midRadius = radius * 1.1 + (index % 3) * 10;
                const midX = center.x + midRadius * Math.cos(midAngle);
                const midY = center.y + midRadius * Math.sin(midAngle);
                
                path.moveTo(source.x, source.y);
                path.quadraticCurveTo(midX, midY, target.x, target.y);
                
                const pathId = `bu-network-path-${index}`;
                model.pathwayElements.push(
                    linkGroup.append('path')
                        .attr('id', pathId)
                        .attr('d', path.toString())
                        .attr('fill', 'none')
                        .attr('stroke', 'rgba(255, 143, 0, 0.3)')
                        .attr('stroke-width', 2)
                        .attr('class', 'path-highlight')
                );
            });

            const nodeGroup = svg.append('g').attr('class', 'sector-nodes');
            const nodes = nodeGroup.selectAll('g')
                .data(sectors)
                .enter().append('g')
                .attr('class', 'sector-group')
                .attr('transform', d => `translate(${d.x},${d.y})`);

            // Dynamic bubble sizes based on capital
            nodes.append('circle')
                .attr('class', 'sector-node')
                .attr('r', d => {
                    // Scale radius based on capital: 14px to 28px
                    const capitalScale = Math.min(1, Math.log10(d.capital + 1) / 10);
                    return 14 + (capitalScale * 14);
                })
                .attr('fill', d => d.color)
                .attr('stroke', '#ffffff')
                .attr('stroke-width', 2)
                .on('mouseenter', function(event, d) {
                    const capital = (d.capital / 10000000).toFixed(1);
                    const info = `${d.name}<br>Capital: ‚Çπ${capital}Cr<br>Size: ${((d.capital/5800000000)*100).toFixed(0)}% of max<br>${d.info}`;
                    showTooltip(info, event.pageX, event.pageY);
                    d3.select(this).attr('stroke-width', 3);
                })
                .on('mousemove', (event) => {
                    tooltip.style('left', (event.pageX + 15) + 'px')
                           .style('top', (event.pageY - 15) + 'px');
                })
                .on('mouseleave', function() {
                    hideTooltip();
                    d3.select(this).attr('stroke-width', 2);
                });

            nodes.append('text')
                .attr('class', 'sector-label')
                .attr('y', d => {
                    const capitalScale = Math.min(1, Math.log10(d.capital + 1) / 10);
                    return 32 + (capitalScale * 5);
                })
                .text(d => d.name.split(' ')[0])
                .attr('fill', '#495057');

            initBottomUpMechanization();

            // Clear existing visualizations
            model.rupeeElements.forEach(el => el.remove());
            model.taxElements.forEach(el => el.remove());
            model.rupeeElements = [];
            model.taxElements = [];
            model.flowParticles = [];
            
            // Start network flow animations
            startBottomUpFlowAnimations(svg, sectors, connections, center, radius);
            
            model.simulation = { svg: svg, sectors: sectors, connections: connections, center: center, radius: radius };
        }

        function startBottomUpFlowAnimations(svg, sectors, connections, center, radius) {
            const model = MODELS.bu;
            
            // Clear existing flows
            model.rupeeElements.forEach(el => el.remove());
            model.rupeeElements = [];
            model.flowParticles = [];
            
            // Function to create realistic network rupee flow
            function createNetworkRupeeFlow(connectionIndex, delay = 0, initialMonth = 0) {
                if (GLOBAL_STATE.cycleCompletePause) return;
                
                const conn = connections[connectionIndex];
                const source = sectors[conn[0]];
                const target = sectors[conn[1]];
                
                // Calculate based on current month
                const monthProgress = Math.min(SYNCHRONIZED_TIMELINE.currentMonth / 36, 1);
                const flowSpeed = 1500 + (monthProgress * 700);
                const rupeeSize = 14 + (monthProgress * 5);
                
                // Calculate curved path
                const startAngle = source.angle;
                const endAngle = target.angle + (target.angle < startAngle ? 2*Math.PI : 0);
                const midAngle = (startAngle + endAngle) / 2;
                const midRadius = radius * 1.1 + (connectionIndex % 3) * 10;
                const midX = center.x + midRadius * Math.cos(midAngle);
                const midY = center.y + midRadius * Math.sin(midAngle);
                
                const rupee = svg.append('text')
                    .attr('class', 'flow-rupee-real')
                    .text('‚Çπ')
                    .attr('font-size', `${rupeeSize}px`)
                    .attr('fill', '#ff8f00')
                    .attr('font-weight', '700')
                    .attr('opacity', 0)
                    .attr('x', source.x)
                    .attr('y', source.y)
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle')
                    .style('filter', 'drop-shadow(0 1px 2px rgba(0,0,0,0.2))');
                
                model.rupeeElements.push(rupee);
                
                const rupeeData = {
                    element: rupee,
                    connectionIndex: connectionIndex,
                    startTime: Date.now(),
                    flowSpeed: flowSpeed,
                    isActive: true,
                    progress: 0
                };
                
                model.flowParticles.push(rupeeData);
                
                function animateRupee() {
                    if (!model.running || !GLOBAL_STATE.isRunning || !rupeeData.isActive || GLOBAL_STATE.cycleCompletePause) {
                        rupeeData.isActive = false;
                        rupee.remove();
                        return;
                    }
                    
                    const elapsed = Date.now() - rupeeData.startTime;
                    rupeeData.progress = Math.min(elapsed / rupeeData.flowSpeed, 1);
                    
                    // Quadratic bezier interpolation
                    const t = rupeeData.progress;
                    const x = (1-t)*(1-t)*source.x + 2*(1-t)*t*midX + t*t*target.x;
                    const y = (1-t)*(1-t)*source.y + 2*(1-t)*t*midY + t*t*target.y;
                    
                    rupee.attr('x', x)
                         .attr('y', y);
                    
                    // Sophisticated opacity animation
                    if (rupeeData.progress < 0.2) {
                        rupee.attr('opacity', rupeeData.progress * 5);
                    } else if (rupeeData.progress > 0.8) {
                        rupee.attr('opacity', (1 - rupeeData.progress) * 5);
                    } else {
                        const pulse = 0.03 * Math.sin(Date.now() / 250);
                        rupee.attr('opacity', 0.9 + pulse);
                    }
                    
                    // Scale animation
                    const scale = 1 + 0.08 * Math.sin(rupeeData.progress * Math.PI);
                    rupee.style('transform', `scale(${scale})`);
                    
                    // Tax particle spawn
                    if (Math.random() < 0.01 && rupeeData.progress > 0.3 && rupeeData.progress < 0.7) {
                        spawnTaxParticleBU(x, y);
                    }
                    
                    if (rupeeData.progress < 1) {
                        requestAnimationFrame(animateRupee);
                    } else {
                        // Enter bubble animation
                        rupee.transition()
                            .duration(150)
                            .attr('opacity', 0)
                            .attr('font-size', `${rupeeSize * 0.6}px`)
                            .on('end', function() {
                                rupeeData.isActive = false;
                                rupee.remove();
                                
                                const rupeeIndex = model.rupeeElements.indexOf(rupee);
                                if (rupeeIndex > -1) model.rupeeElements.splice(rupeeIndex, 1);
                                
                                const particleIndex = model.flowParticles.indexOf(rupeeData);
                                if (particleIndex > -1) model.flowParticles.splice(particleIndex, 1);
                                
                                // Continue network flow
                                if (model.running && GLOBAL_STATE.isRunning && !GLOBAL_STATE.cycleCompletePause && Math.random() < 0.6) {
                                    setTimeout(() => {
                                        createNetworkRupeeFlow(
                                            Math.floor(Math.random() * connections.length),
                                            Math.random() * 400,
                                            SYNCHRONIZED_TIMELINE.currentMonth
                                        );
                                    }, 200 + Math.random() * 300);
                                }
                            });
                    }
                }
                
                setTimeout(() => {
                    if (model.running && GLOBAL_STATE.isRunning && !GLOBAL_STATE.cycleCompletePause) {
                        rupeeData.startTime = Date.now();
                        requestAnimationFrame(animateRupee);
                    }
                }, delay);
            }
            
            // Initialize network flows
            for (let i = 0; i < Math.min(connections.length, 6); i++) {
                createNetworkRupeeFlow(i, i * 200, SYNCHRONIZED_TIMELINE.currentMonth);
            }
            
            // Dynamic flow management
            setInterval(() => {
                if (!model.running || !GLOBAL_STATE.isRunning || GLOBAL_STATE.cycleCompletePause) return;
                
                const monthProgress = SYNCHRONIZED_TIMELINE.currentMonth / 36;
                const targetFlowCount = 4 + Math.floor(monthProgress * 8);
                
                if (model.flowParticles.length < targetFlowCount) {
                    createNetworkRupeeFlow(
                        Math.floor(Math.random() * connections.length),
                        Math.random() * 200,
                        SYNCHRONIZED_TIMELINE.currentMonth
                    );
                }
            }, 1800);
        }

        function spawnTaxParticleBU(sourceX, sourceY) {
            const model = MODELS.bu;
            const svg = model.simulation?.svg;
            if (!svg || GLOBAL_STATE.cycleCompletePause) return;
            
            // Get tax metric position
            const taxMetric = document.getElementById('tax-bu');
            const taxRect = taxMetric.getBoundingClientRect();
            const containerRect = document.getElementById('viz-bu').getBoundingClientRect();
            
            // Calculate target position inside the tax box (NOT to the right)
            const targetX = taxRect.left - containerRect.left + taxRect.width * 0.3;
            const targetY = taxRect.top - containerRect.top + taxRect.height / 2;
            
            // Create tax particle
            const taxParticle = svg.append('circle')
                .attr('class', 'tax-particle')
                .attr('cx', sourceX)
                .attr('cy', sourceY)
                .attr('r', 2)
                .attr('fill', '#d32f2f')
                .attr('opacity', 0.9);
            
            model.taxElements.push(taxParticle);
            
            // Animate to tax metric
            taxParticle.transition()
                .duration(500)
                .attr('cx', targetX)
                .attr('cy', targetY)
                .attr('r', 3)
                .on('end', function() {
                    // Clean burst animation
                    d3.select(this)
                        .transition()
                        .duration(300)
                        .attr('r', 6)
                        .attr('opacity', 0)
                        .on('end', function() {
                            d3.select(this).remove();
                            const index = model.taxElements.indexOf(taxParticle);
                            if (index > -1) model.taxElements.splice(index, 1);
                        });
                });
        }

        // ==================== UPDATED HELPER FUNCTIONS ====================
        
        function updateTimeElapsed() {
            const timeElapsed = document.getElementById('global-time-elapsed');
            
            if (GLOBAL_STATE.cycleCompletePause) {
                // Don't update time during cycle complete pause
                return;
            }
            
            const now = Date.now();
            
            if (GLOBAL_STATE.isRunning && !GLOBAL_STATE.lastPauseTime) {
                const elapsedSeconds = Math.floor((now - GLOBAL_STATE.startTime - GLOBAL_STATE.timePaused) / 1000);
                timeElapsed.textContent = `${elapsedSeconds}s`;
            }
        }

        function updateModelDisplays(modelType, gva, tax, employment, velocity, progress) {
            const prefix = modelType;
            const formatCr = (value) => `‚Çπ${(value/10000000).toFixed(1)}Cr`;
            
            // Update displays
            if (gva > 0 || GLOBAL_STATE.cycleCompleteStage === 0) {
                document.getElementById(`gdp-${prefix}`).textContent = formatCr(gva);
            }
            if (tax > 0 || GLOBAL_STATE.cycleCompleteStage === 0) {
                document.getElementById(`tax-${prefix}`).textContent = formatCr(tax);
            }
            if (velocity > 0 || GLOBAL_STATE.cycleCompleteStage === 0) {
                document.getElementById(`velocity-${prefix}`).textContent = velocity.toFixed(1);
            }
            
            document.getElementById(`${prefix}-tax`).textContent = tax > 0 ? formatCr(tax) : '‚Çπ0';
            document.getElementById(`${prefix}-velocity`).textContent = velocity > 0 ? velocity.toFixed(1) + 'x' : '0.0x';
            
            if (modelType === 'td') {
                document.getElementById(`${prefix}-jobs`).textContent = employment > 0 ? Math.floor(employment) : '0';
                // RESTORED: Capital invested value
                const capitalValue = 100 * (0.3 + 0.7 * progress); // From original calculation
                document.getElementById(`${prefix}-capital`).textContent = `‚Çπ${capitalValue.toFixed(1)}Cr`;
            } else {
                document.getElementById(`${prefix}-businesses`).textContent = employment > 0 ? Math.floor(employment / 4) : '0';
                document.getElementById(`${prefix}-transactions`).textContent = gva > 0 ? Math.floor(gva / 50000) : '0';
            }
            
            updateSectorValues(modelType, progress);
        }

        function updateDetailedMetrics(modelType, gva, tax, velocity, progress) {
            const prefix = modelType;
            
            const formatCr = (value) => value > 0 ? `‚Çπ${(value/10000000).toFixed(1)}Cr` : '‚Çπ0';
            
            const inCirculation = modelType === 'td' ? 
                1000000000 * (0.3 + 0.7 * progress) : 
                1000000000 * (0.4 + 0.6 * progress);
            
            document.getElementById(`${prefix}-amount`).textContent = inCirculation > 0 ? formatCr(inCirculation) : '‚Çπ0';
            document.getElementById(`${prefix}-tax-generated`).textContent = tax > 0 ? formatCr(tax) : '‚Çπ0';
            document.getElementById(`${prefix}-gdp-contribution`).textContent = gva > 0 ? formatCr(gva) : '‚Çπ0';
            document.getElementById(`${prefix}-velocity-impact`).textContent = velocity > 0 ? velocity.toFixed(1) : '0.0';
        }

        function updateSectorValues(modelType, progress) {
            const prefix = modelType;
            const formatValue = (value) => {
                if (value === 0) return '‚Çπ0';
                if (value >= 100000000) return `‚Çπ${(value/10000000).toFixed(1)}Cr`;
                return `‚Çπ${(value/100000).toFixed(1)}L`;
            };
            
            if (modelType === 'td') {
                const govValue = progress * 300000000;
                const corpValue = 7000000000 * (1 - progress * 0.5); // RESTORED: Original calculation
                const msmeValue = 100000000 + progress * 4000000000;
                const houseValue = progress * 3000000000;
                const finValue = 1500000000 * (1 - progress * 0.8);
                const agriValue = progress * 500000000;
                
                document.getElementById(`${prefix}-sector-gov`).textContent = formatValue(govValue);
                document.getElementById(`${prefix}-sector-corp`).textContent = formatValue(corpValue);
                document.getElementById(`${prefix}-sector-msme`).textContent = formatValue(msmeValue);
                document.getElementById(`${prefix}-sector-house`).textContent = formatValue(houseValue);
                document.getElementById(`${prefix}-sector-fin`).textContent = formatValue(finValue);
                document.getElementById(`${prefix}-sector-agri`).textContent = formatValue(agriValue);
            } else {
                const govValue = progress * 1200000000;
                const corpValue = progress * 800000000;
                const msmeValue = 4200000000 * (1 - progress * 0.6); // RESTORED: Original calculation
                const houseValue = 5800000000 * (1 - progress * 0.8); // RESTORED: Original calculation
                const finValue = progress * 400000000;
                const agriValue = progress * 600000000;
                
                document.getElementById(`${prefix}-sector-gov`).textContent = formatValue(govValue);
                document.getElementById(`${prefix}-sector-corp`).textContent = formatValue(corpValue);
                document.getElementById(`${prefix}-sector-msme`).textContent = formatValue(msmeValue);
                document.getElementById(`${prefix}-sector-house`).textContent = formatValue(houseValue);
                document.getElementById(`${prefix}-sector-fin`).textContent = formatValue(finValue);
                document.getElementById(`${prefix}-sector-agri`).textContent = formatValue(agriValue);
            }
        }

        function updateSectorChanges(modelType, progress) {
            const prefix = modelType;
            
            if (modelType === 'td') {
                const changes = {
                    gov: Math.round(progress * 100),
                    corp: Math.round(-progress * 50),
                    msme: Math.round(progress * 400),
                    house: Math.round(progress * 100),
                    fin: Math.round(-progress * 80),
                    agri: Math.round(progress * 100)
                };
                
                document.getElementById(`${prefix}-sector-gov-change`).textContent = `${changes.gov > 0 ? '+' : ''}${changes.gov}%`;
                document.getElementById(`${prefix}-sector-corp-change`).textContent = `${changes.corp > 0 ? '+' : ''}${changes.corp}%`;
                document.getElementById(`${prefix}-sector-msme-change`).textContent = `${changes.msme > 0 ? '+' : ''}${changes.msme}%`;
                document.getElementById(`${prefix}-sector-house-change`).textContent = `${changes.house > 0 ? '+' : ''}${changes.house}%`;
                document.getElementById(`${prefix}-sector-fin-change`).textContent = `${changes.fin > 0 ? '+' : ''}${changes.fin}%`;
                document.getElementById(`${prefix}-sector-agri-change`).textContent = `${changes.agri > 0 ? '+' : ''}${changes.agri}%`;
                
                document.getElementById(`${prefix}-sector-gov-change`).className = `sector-change ${changes.gov >= 0 ? 'positive' : 'negative'}`;
                document.getElementById(`${prefix}-sector-corp-change`).className = `sector-change ${changes.corp >= 0 ? 'positive' : 'negative'}`;
                document.getElementById(`${prefix}-sector-msme-change`).className = `sector-change ${changes.msme >= 0 ? 'positive' : 'negative'}`;
                document.getElementById(`${prefix}-sector-house-change`).className = `sector-change ${changes.house >= 0 ? 'positive' : 'negative'}`;
                document.getElementById(`${prefix}-sector-fin-change`).className = `sector-change ${changes.fin >= 0 ? 'positive' : 'negative'}`;
                document.getElementById(`${prefix}-sector-agri-change`).className = `sector-change ${changes.agri >= 0 ? 'positive' : 'negative'}`;
            } else {
                const changes = {
                    gov: Math.round(progress * 100),
                    corp: Math.round(progress * 100),
                    msme: Math.round(-progress * 60),
                    house: Math.round(-progress * 80),
                    fin: Math.round(progress * 100),
                    agri: Math.round(progress * 100)
                };
                
                document.getElementById(`${prefix}-sector-gov-change`).textContent = `${changes.gov > 0 ? '+' : ''}${changes.gov}%`;
                document.getElementById(`${prefix}-sector-corp-change`).textContent = `${changes.corp > 0 ? '+' : ''}${changes.corp}%`;
                document.getElementById(`${prefix}-sector-msme-change`).textContent = `${changes.msme > 0 ? '+' : ''}${changes.msme}%`;
                document.getElementById(`${prefix}-sector-house-change`).textContent = `${changes.house > 0 ? '+' : ''}${changes.house}%`;
                document.getElementById(`${prefix}-sector-fin-change`).textContent = `${changes.fin > 0 ? '+' : ''}${changes.fin}%`;
                document.getElementById(`${prefix}-sector-agri-change`).textContent = `${changes.agri > 0 ? '+' : ''}${changes.agri}%`;
                
                document.getElementById(`${prefix}-sector-gov-change`).className = `sector-change ${changes.gov >= 0 ? 'positive' : 'negative'}`;
                document.getElementById(`${prefix}-sector-corp-change`).className = `sector-change ${changes.corp >= 0 ? 'positive' : 'negative'}`;
                document.getElementById(`${prefix}-sector-msme-change`).className = `sector-change ${changes.msme >= 0 ? 'positive' : 'negative'}`;
                document.getElementById(`${prefix}-sector-house-change`).className = `sector-change ${changes.house >= 0 ? 'positive' : 'negative'}`;
                document.getElementById(`${prefix}-sector-fin-change`).className = `sector-change ${changes.fin >= 0 ? 'positive' : 'negative'}`;
                document.getElementById(`${prefix}-sector-agri-change`).className = `sector-change ${changes.agri >= 0 ? 'positive' : 'negative'}`;
            }
        }

        function updateBubbleSizes(modelType, progress) {
            const model = MODELS[modelType];
            const simulation = model.simulation;
            if (!simulation || !simulation.sectors) return;
            
            const sectors = simulation.sectors;
            
            // Update bubble sizes based on progress
            d3.selectAll(`#viz-${modelType} .sector-node`)
                .data(sectors)
                .attr('r', d => {
                    let capital;
                    if (modelType === 'td') {
                        if (d.id === 'capital') capital = 8500000000 * (1 - progress * 0.3);
                        else if (d.id === 'corporates') capital = 7000000000 * progress;
                        else if (d.id === 'msme') capital = 100000000 + progress * 4000000000;
                        else if (d.id === 'household') capital = progress * 3000000000;
                        else if (d.id === 'finance') capital = 1500000000 * (1 - progress * 0.8);
                        else if (d.id === 'government') capital = progress * 300000000;
                        else capital = progress * 500000000;
                    } else {
                        if (d.id === 'households') capital = 5800000000 * (1 - progress * 0.8);
                        else if (d.id === 'msme') capital = 4200000000 * (1 - progress * 0.6);
                        else if (d.id === 'government') capital = progress * 1200000000;
                        else if (d.id === 'corporates') capital = progress * 800000000;
                        else if (d.id === 'finance') capital = progress * 400000000;
                        else if (d.id === 'agriculture') capital = progress * 600000000;
                        else capital = progress * 500000000;
                    }
                    
                    const maxCapital = modelType === 'td' ? 8500000000 : 5800000000;
                    const capitalScale = Math.min(1, Math.log10(capital + 1) / Math.log10(maxCapital + 1));
                    return modelType === 'td' ? 15 + (capitalScale * 15) : 14 + (capitalScale * 14);
                });
        }

        function updateFlowDescriptionDynamic(modelType, month) {
            const phase = Math.min(Math.floor(month / 9), 3);
            const prefix = modelType;
            const descriptions = getFlowDescription(modelType, month);
            
            document.getElementById(`${prefix}-flow-title`).textContent = descriptions.title;
            document.getElementById(`${prefix}-flow-step`).textContent = `Month ${month}/36`;
            document.getElementById(`${prefix}-flow-text`).textContent = descriptions.details;
            
            const detailsEl = document.getElementById(`${prefix}-flow-details`);
            detailsEl.innerHTML = `
                <div class="detail-section">
                    <div class="detail-label">Timeline:</div>
                    <div class="detail-value">Month ${month} of 36 (${((month/36)*100).toFixed(0)}% complete)</div>
                </div>
                <div class="detail-section">
                    <div class="detail-label">Current Phase:</div>
                    <div class="detail-value">${descriptions.phase}</div>
                </div>
                <div class="detail-section">
                    <div class="detail-label">Synchronization:</div>
                    <div class="detail-value">Both models at Month ${month}/36 (parallel timeline)</div>
                </div>
            `;
        }

        function getFlowDescription(modelType, month) {
            const descriptions = {
                td: [
                    {
                        title: "Infrastructure Capital Deployment Phase",
                        details: `Government allocates ‚Çπ100 crore for large-scale projects. ‚Çπ${(70-month*0.5).toFixed(1)}Cr to corporations, ‚Çπ${(20-month*0.3).toFixed(1)}Cr in financial system.`,
                        phase: "Phase 1: Capital Deployment (Months 0-8)"
                    },
                    {
                        title: "Construction & Implementation Phase",
                        details: `Physical construction begins across ${Math.floor(month/3)} project sites. Supply chain activation creating demand for materials and labor.`,
                        phase: "Phase 2: Construction (Months 9-17)"
                    },
                    {
                        title: "Commissioning & Operations Phase",
                        details: `${Math.floor(month/6)} major projects begin operations. Economic multiplier effects generating secondary economic activity.`,
                        phase: "Phase 3: Operations (Months 18-26)"
                    },
                    {
                        title: "Capacity Utilization & Expansion",
                        details: `Infrastructure operating at ${(month/36*85).toFixed(0)}% capacity. Creating permanent economic assets and formal employment stability.`,
                        phase: "Phase 4: Maturity (Months 27-36)"
                    }
                ],
                bu: [
                    {
                        title: "Immediate Consumption Activation",
                        details: `‚Çπ100 crore directly to households and MSMEs. Daily transactions averaging ‚Çπ${(5000000/Math.max(1, month/3)).toLocaleString()} per day with ${(2+month*0.1).toFixed(1)}x velocity.`,
                        phase: "Phase 1: Consumption Activation (Months 0-8)"
                    },
                    {
                        title: "Local Economy Network Effects",
                        details: `Money circulates through ${Math.floor(month*1.5)} local supply chains. ${Math.min(100, Math.floor(350/Math.max(1, month)*100))}% of MSMEs reporting increased business.`,
                        phase: "Phase 2: Network Effects (Months 9-17)"
                    },
                    {
                        title: "Market Integration & Scale",
                        details: `Successful businesses scaling up. Local consumption patterns stabilizing with ${(4+month*0.05).toFixed(1)}x sustained velocity.`,
                        phase: "Phase 3: Market Integration (Months 18-26)"
                    },
                    {
                        title: "Sustainable Livelihood Ecosystem",
                        details: `Stable economic ecosystem supporting ${Math.floor(5850*month/36)} livelihoods. Consumption-driven growth creating resilient local economies.`,
                        phase: "Phase 4: Ecosystem Maturity (Months 27-36)"
                    }
                ]
            };
            
            const phase = Math.min(Math.floor(month / 9), 3);
            return descriptions[modelType][phase];
        }

        // ==================== CENTRAL CONTROL FUNCTIONS ====================
        
        function restartAllModels() {
            // Clear any cycle complete pause
            if (GLOBAL_STATE.cycleCompleteTimer) {
                clearTimeout(GLOBAL_STATE.cycleCompleteTimer);
                GLOBAL_STATE.cycleCompleteTimer = null;
            }
            GLOBAL_STATE.cycleCompletePause = false;
            GLOBAL_STATE.cycleCompleteStage = 0;
            
            // Reset global state
            GLOBAL_STATE.startTime = Date.now();
            GLOBAL_STATE.totalElapsedTime = 0;
            GLOBAL_STATE.timePaused = 0;
            GLOBAL_STATE.lastPauseTime = null;
            GLOBAL_STATE.isRunning = true;
            
            // Update central controls
            document.getElementById('global-pause-btn').textContent = 'Pause';
            document.getElementById('global-time-elapsed').textContent = '0s';
            document.getElementById('global-time-elapsed').style.color = '';
            document.getElementById('global-time-elapsed').style.fontWeight = '';
            
            // Restart individual models
            restartModel('td');
            restartModel('bu');
            
            // Restart timeline
            SYNCHRONIZED_TIMELINE.currentMonth = 0.1;
            SYNCHRONIZED_TIMELINE.isRunning = true;
            
            console.log("Both models restarted");
        }
        
        function pauseAllModels() {
            GLOBAL_STATE.isRunning = !GLOBAL_STATE.isRunning;
            const btn = document.getElementById('global-pause-btn');
            
            if (GLOBAL_STATE.isRunning) {
                btn.textContent = 'Pause';
                // Resume timing
                if (GLOBAL_STATE.lastPauseTime) {
                    GLOBAL_STATE.timePaused += Date.now() - GLOBAL_STATE.lastPauseTime;
                    GLOBAL_STATE.lastPauseTime = null;
                }
                SYNCHRONIZED_TIMELINE.isRunning = true;
                MODELS.td.running = true;
                MODELS.bu.running = true;
                
                // Restart animations if not in cycle complete pause
                if (!GLOBAL_STATE.cycleCompletePause) {
                    if (MODELS.td.simulation) {
                        startTopDownFlowAnimations(MODELS.td.simulation.svg, MODELS.td.simulation.sectors, 
                                                  MODELS.td.simulation.center, MODELS.td.simulation.radius);
                    }
                    if (MODELS.bu.simulation) {
                        startBottomUpFlowAnimations(MODELS.bu.simulation.svg, MODELS.bu.simulation.sectors, 
                                                   MODELS.bu.simulation.connections, MODELS.bu.simulation.center, 
                                                   MODELS.bu.simulation.radius);
                    }
                }
            } else {
                btn.textContent = 'Resume';
                GLOBAL_STATE.lastPauseTime = Date.now();
                SYNCHRONIZED_TIMELINE.isRunning = false;
                MODELS.td.running = false;
                MODELS.bu.running = false;
            }
            
            // Update individual model buttons
            document.getElementById('toggle-td').textContent = GLOBAL_STATE.isRunning ? 'Pause' : 'Resume';
            document.getElementById('toggle-bu').textContent = GLOBAL_STATE.isRunning ? 'Pause' : 'Resume';
        }

        // ==================== INDIVIDUAL MODEL CONTROL FUNCTIONS ====================
        
        function restartModel(modelName) {
            const model = MODELS[modelName];
            model.running = true;
            model.currentFlowIndex = 0;
            
            // Reset data (RESTORED original values)
            model.data.totalCapital = 1000000000;
            model.data.gdp = 0;
            model.data.taxCollected = 0;
            model.data.velocity = 0;
            model.data.transactionValue = 0;
            
            // Clear all visualization elements
            model.rupeeElements.forEach(p => p.remove());
            model.taxElements.forEach(p => p.remove());
            model.pathwayElements.forEach(p => p.remove());
            model.rupeeElements = [];
            model.taxElements = [];
            model.pathwayElements = [];
            model.flowParticles = [];
            
            // Reset displays (RESTORED original starting values)
            d3.select(model.gdpEl).text('‚Çπ0');
            d3.select(model.taxEl).text('‚Çπ0');
            d3.select(model.velocityEl).text('0.0');
            
            if (modelName === 'td') {
                document.getElementById('td-tax').textContent = '‚Çπ0';
                document.getElementById('td-velocity').textContent = '0.0x';
                document.getElementById('td-jobs').textContent = '0';
                document.getElementById('td-capital').textContent = '‚Çπ100.0Cr'; // RESTORED
                
                document.getElementById('td-amount').textContent = '‚Çπ0';
                document.getElementById('td-tax-generated').textContent = '‚Çπ0';
                document.getElementById('td-gdp-contribution').textContent = '‚Çπ0';
                document.getElementById('td-velocity-impact').textContent = '0.0';
                
                document.getElementById('td-sector-gov').textContent = '‚Çπ0';
                document.getElementById('td-sector-corp').textContent = '‚Çπ85.0Cr'; // RESTORED
                document.getElementById('td-sector-msme').textContent = '‚Çπ0';
                document.getElementById('td-sector-house').textContent = '‚Çπ0';
                document.getElementById('td-sector-fin').textContent = '‚Çπ15.0Cr'; // RESTORED
                document.getElementById('td-sector-agri').textContent = '‚Çπ0';
                
                document.getElementById('td-flow-title').textContent = 'Infrastructure Capital Deployment Phase';
                document.getElementById('td-flow-step').textContent = 'Month 0/36';
                document.getElementById('td-flow-text').textContent = 'Government allocates ‚Çπ100 crore for large-scale projects. ‚Çπ70.0Cr to corporations, ‚Çπ20.0Cr in financial system.';
                
                initTopDownModel();
                initTopDownMechanization();
            } else {
                document.getElementById('bu-tax').textContent = '‚Çπ0';
                document.getElementById('bu-velocity').textContent = '0.0x';
                document.getElementById('bu-transactions').textContent = '0';
                document.getElementById('bu-businesses').textContent = '0';
                
                document.getElementById('bu-amount').textContent = '‚Çπ0';
                document.getElementById('bu-tax-generated').textContent = '‚Çπ0';
                document.getElementById('bu-gdp-contribution').textContent = '‚Çπ0';
                document.getElementById('bu-velocity-impact').textContent = '0.0';
                
                document.getElementById('bu-sector-gov').textContent = '‚Çπ0';
                document.getElementById('bu-sector-corp').textContent = '‚Çπ0';
                document.getElementById('bu-sector-msme').textContent = '‚Çπ42.0Cr'; // RESTORED
                document.getElementById('bu-sector-house').textContent = '‚Çπ58.0Cr'; // RESTORED
                document.getElementById('bu-sector-fin').textContent = '‚Çπ0';
                document.getElementById('bu-sector-agri').textContent = '‚Çπ0';
                
                document.getElementById('bu-flow-title').textContent = 'Immediate Consumption Activation';
                document.getElementById('bu-flow-step').textContent = 'Month 0/36';
                document.getElementById('bu-flow-text').textContent = '‚Çπ100 crore directly to households and MSMEs. Daily transactions averaging ‚ÇπInfinity per day with 2.0x velocity.';
                
                initBottomUpModel();
                initBottomUpMechanization();
            }
            
            document.getElementById(`toggle-${modelName}`).textContent = 'Pause';
            
            console.log(`${modelName.toUpperCase()} Model: Restarted`);
        }
        
        function toggleModel(modelName) {
            const model = MODELS[modelName];
            model.running = !model.running;
            const btn = document.getElementById(`toggle-${modelName}`);
            
            btn.textContent = model.running ? 'Pause' : 'Resume';
            
            // Also update global state if both models are being controlled individually
            if (MODELS.td.running !== MODELS.bu.running) {
                // Models are out of sync, update global button to show "Resume Both"
                document.getElementById('global-pause-btn').textContent = 'Resume Both';
                GLOBAL_STATE.isRunning = false;
            } else {
                // Models are in sync
                GLOBAL_STATE.isRunning = model.running;
                document.getElementById('global-pause-btn').textContent = model.running ? 'Pause' : 'Resume';
            }
        }

        // ==================== TIMELINE FUNCTIONS ====================
        
        function generateRealisticTimelineData() {
            const months = 36;
            
            const tdGVA = [];
            const tdTax = [];
            const tdVelocity = [];
            const tdEmployment = [];
            
            const buGVA = [];
            const buTax = [];
            const buVelocity = [];
            const buEmployment = [];
            
            for (let month = 0; month <= months; month++) {
                const progress = month / months;
                
                // Top-Down: Always increasing, no decrease
                const tdBase = 1 - Math.exp(-progress * 2.5);
                const tdFluct = Math.sin(progress * Math.PI * 4) * 0.05 + 
                               Math.cos(progress * Math.PI * 2) * 0.03;
                
                tdGVA.push(6375000000 * tdBase * (1 + Math.abs(tdFluct) * 0.5));
                tdTax.push(1530000000 * tdBase * (1 + Math.abs(tdFluct) * 0.4));
                tdVelocity.push(2.5 * (1 - Math.exp(-progress * 1.8)) * (1 + Math.abs(tdFluct) * 0.2));
                tdEmployment.push(5160 * tdBase * (1 + Math.abs(tdFluct) * 0.3));
                
                // Bottom-Up: Always increasing with saturation
                const buBase = 1 - Math.exp(-progress * 3.5);
                const buFluct = Math.sin(progress * Math.PI * 3) * 0.08 + 
                               Math.cos(progress * Math.PI * 5) * 0.04;
                const saturation = 1 - 0.3 * Math.exp(-progress * 2.0); // Saturation effect
                
                buGVA.push(11700000000 * buBase * saturation * (1 + Math.abs(buFluct) * 0.3));
                buTax.push(1053000000 * buBase * saturation * (1 + Math.abs(buFluct) * 0.3));
                buVelocity.push(6.0 * (0.3 + 0.7 * (1 - Math.exp(-progress * 4.0))) * saturation * (1 + Math.abs(buFluct) * 0.1));
                buEmployment.push(12500 * buBase * saturation * (1 + Math.abs(buFluct) * 0.2));
            }
            
            return { tdGVA, tdTax, tdVelocity, tdEmployment, buGVA, buTax, buVelocity, buEmployment };
        }

        function initTimeline() {
            const container = document.getElementById('timeline-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            d3.select('#timeline-container').select('svg').remove();
            
            timelineSvg = d3.select('#timeline-container').append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', `0 0 ${width} ${height}`)
                .append('g')
                .attr('transform', `translate(${width * 0.1}, ${height * 0.1})`);
            
            const plotWidth = width * 0.8;
            const plotHeight = height * 0.75;
            
            const maxTime = 36;
            const realisticData = generateRealisticTimelineData();
            
            let tdData, buData, maxValue;
            
            switch(currentTimelineMetric) {
                case 'gdp':
                    tdData = realisticData.tdGVA;
                    buData = realisticData.buGVA;
                    maxValue = Math.max(d3.max(tdData), d3.max(buData)) * 1.1;
                    break;
                case 'tax':
                    tdData = realisticData.tdTax;
                    buData = realisticData.buTax;
                    maxValue = Math.max(d3.max(tdData), d3.max(buData)) * 1.1;
                    break;
                case 'velocity':
                    tdData = realisticData.tdVelocity;
                    buData = realisticData.buVelocity;
                    maxValue = Math.max(d3.max(tdData), d3.max(buData)) * 1.1;
                    break;
                case 'employment':
                    tdData = realisticData.tdEmployment;
                    buData = realisticData.buEmployment;
                    maxValue = Math.max(d3.max(tdData), d3.max(buData)) * 1.1;
                    break;
            }
            
            const xScale = d3.scaleLinear()
                .domain([0, maxTime])
                .range([0, plotWidth]);
                
            const yScale = d3.scaleLinear()
                .domain([0, maxValue])
                .range([plotHeight, 0]);
            
            timelineSvg.append('g')
                .attr('class', 'timeline-grid')
                .attr('transform', `translate(0, ${plotHeight})`)
                .call(d3.axisBottom(xScale)
                    .ticks(9)
                    .tickSize(-plotHeight)
                    .tickFormat(d => `${d}M`));
            
            timelineSvg.append('g')
                .attr('class', 'timeline-grid')
                .call(d3.axisLeft(yScale)
                    .ticks(6)
                    .tickSize(-plotWidth)
                    .tickFormat(d => {
                        if (currentTimelineMetric === 'gdp' || currentTimelineMetric === 'tax') {
                            return `${(d/100000000).toFixed(0)}Cr`;
                        }
                        if (currentTimelineMetric === 'employment' && d > 1000) {
                            return `${(d/1000).toFixed(0)}k`;
                        }
                        return d;
                    }));
            
            let yLabel = '';
            switch(currentTimelineMetric) {
                case 'gdp': 
                    yLabel = 'GDP Contribution'; 
                    break;
                case 'tax': 
                    yLabel = 'Tax Collected'; 
                    break;
                case 'velocity': 
                    yLabel = 'Transaction Velocity'; 
                    break;
                case 'employment': 
                    yLabel = 'Employment Impact'; 
                    break;
            }
            
            timelineSvg.append('text')
                .attr('class', 'timeline-axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('x', -plotHeight/2)
                .attr('y', -60)
                .attr('text-anchor', 'middle')
                .text(`${yLabel}`);
            
            timelineSvg.append('text')
                .attr('class', 'timeline-axis-label')
                .attr('x', plotWidth/2)
                .attr('y', plotHeight + 35)
                .attr('text-anchor', 'middle')
                .text('Time (Months)');
            
            const tooltip = timelineSvg.append('g')
                .attr('class', 'timeline-metric')
                .style('opacity', 0);
            
            const line = d3.line()
                .x((d, i) => xScale(i))
                .y(d => yScale(d))
                .curve(d3.curveMonotoneX);
            
            timelineSvg.append('path')
                .datum(tdData)
                .attr('class', 'timeline-line td')
                .attr('d', line)
                .style('opacity', 0.9);
            
            timelineSvg.append('path')
                .datum(buData)
                .attr('class', 'timeline-line bu')
                .attr('d', line)
                .style('opacity', 0.9);
            
            const pointsGroup = timelineSvg.append('g').attr('class', 'data-points');
            
            pointsGroup.selectAll('.point-td')
                .data(tdData)
                .enter().append('circle')
                .attr('class', 'timeline-point td')
                .attr('cx', (d, i) => xScale(i))
                .attr('cy', d => yScale(d))
                .attr('r', 4)
                .on('mouseover', function(event, d, i) {
                    tooltip.transition().duration(200).style('opacity', .95);
                    const xPos = xScale(i);
                    const yPos = yScale(d) - 45;
                    tooltip.attr('transform', `translate(${xPos}, ${yPos})`);
                    
                    let detail = '';
                    switch(currentTimelineMetric) {
                        case 'gdp': detail = `Cumulative GDP: Month ${i}`; break;
                        case 'tax': detail = `Cumulative Tax: Month ${i}`; break;
                        case 'velocity': detail = `Velocity at Month ${i}`; break;
                        case 'employment': detail = `Jobs created by Month ${i}`; break;
                    }
                    
                    tooltip.html(`
                        <div style="font-weight:600;color:#1e88e5;margin-bottom:3px;">Top-Down Model</div>
                        <div>Month ${i}/36</div>
                        <div style="font-weight:600;margin:5px 0;">${yLabel}: ${formatTimelineValue(d, currentTimelineMetric)}</div>
                        <div style="font-size:0.8em;color:#666;">${detail}</div>
                    `);
                })
                .on('mouseout', function() {
                    tooltip.transition().duration(500).style('opacity', 0);
                });
            
            pointsGroup.selectAll('.point-bu')
                .data(buData)
                .enter().append('circle')
                .attr('class', 'timeline-point bu')
                .attr('cx', (d, i) => xScale(i))
                .attr('cy', d => yScale(d))
                .attr('r', 4)
                .on('mouseover', function(event, d, i) {
                    tooltip.transition().duration(200).style('opacity', .95);
                    const xPos = xScale(i);
                    const yPos = yScale(d) - 45;
                    tooltip.attr('transform', `translate(${xPos}, ${yPos})`);
                    
                    let detail = '';
                    switch(currentTimelineMetric) {
                        case 'gdp': detail = `Cumulative GDP: Month ${i}`; break;
                        case 'tax': detail = `Cumulative Tax: Month ${i}`; break;
                        case 'velocity': detail = `Velocity at Month ${i}`; break;
                        case 'employment': detail = `Enterprises supported by Month ${i}`; break;
                    }
                    
                    tooltip.html(`
                        <div style="font-weight:600;color:#ff8f00;margin-bottom:3px;">Bottom-Up Model</div>
                        <div>Month ${i}/36</div>
                        <div style="font-weight:600;margin:5px 0;">${yLabel}: ${formatTimelineValue(d, currentTimelineMetric)}</div>
                        <div style="font-size:0.8em;color:#666;">${detail}</div>
                    `);
                })
                .on('mouseout', function() {
                    tooltip.transition().duration(500).style('opacity', 0);
                });
            
            let metricTitle = '';
            switch(currentTimelineMetric) {
                case 'gdp': metricTitle = 'GDP Contribution'; break;
                case 'tax': metricTitle = 'Tax Revenue'; break;
                case 'velocity': metricTitle = 'Money Velocity'; break;
                case 'employment': metricTitle = 'Employment Impact'; break;
            }
            
            timelineSvg.append('text')
                .attr('x', plotWidth/2)
                .attr('y', -10)
                .attr('text-anchor', 'middle')
                .style('font-size', '1.1rem')
                .style('font-weight', '600')
                .style('fill', '#1a1a1a')
                .text(`${metricTitle} Growth Comparison`);
            
            timelineSvg.append('text')
                .attr('x', plotWidth/2)
                .attr('y', plotHeight + 50)
                .attr('text-anchor', 'middle')
                .style('font-size', '0.75rem')
                .style('fill', '#6c757d')
                .text('Note: Both models start with ‚Çπ100 crore. GDP and Tax shown are cumulative over 36 months.');
        }

        function formatTimelineValue(value, metric) {
            switch(metric) {
                case 'gdp': return `‚Çπ${(value/100000000).toFixed(1)}Cr`;
                case 'tax': return `‚Çπ${(value/100000000).toFixed(2)}Cr`;
                case 'velocity': return `${value.toFixed(1)}x`;
                case 'employment': 
                    if (value < 1000) return `${Math.round(value)} jobs`;
                    return `${(value/1000).toFixed(1)}k jobs/enterprises`;
                default: return value.toFixed(1);
            }
        }

        function showTimelineMetric(metric) {
            currentTimelineMetric = metric;
            
            d3.selectAll('.timeline-btn')
                .classed('active', false);
            d3.select(`button[onclick="showTimelineMetric('${metric}')"]`)
                .classed('active', true);
            
            initTimeline();
        }

        // ==================== MECHANIZATION VIEW FUNCTIONS (WITH RUPPEE FLOW) ====================
        
        function initTopDownMechanization() {
            const model = MODELS.td;
            const container = document.querySelector(model.mechContainer);
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            d3.select(model.mechContainer).select('svg').remove();
            
            const svg = d3.select(model.mechContainer).append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', `0 0 ${width} ${height}`);
            
            const nodes = [
                { id: 'banks', label: 'Banks & Funds', x: width * 0.1, y: height/2, color: '#1e88e5', size: 20 },
                { id: 'corporates', label: 'Large Corps', x: width * 0.3, y: height/2, color: '#1565c0', size: 18 },
                { id: 'projects', label: 'Major Projects', x: width * 0.5, y: height/2, color: '#00a152', size: 16 },
                { id: 'wages', label: 'Salaries', x: width * 0.7, y: height/2, color: '#ff8f00', size: 14 },
                { id: 'spending', label: 'Consumer Spend', x: width * 0.85, y: height/2, color: '#f57c00', size: 12 },
                { id: 'tax', label: 'Tax Revenue', x: width * 0.95, y: height/2, color: '#673ab7', size: 10 }
            ];
            
            const links = [
                { source: 'banks', target: 'corporates' },
                { source: 'corporates', target: 'projects' },
                { source: 'corporates', target: 'wages' },
                { source: 'projects', target: 'wages' },
                { source: 'wages', target: 'spending' },
                { source: 'spending', target: 'tax' }
            ];
            
            // Create pathways
            links.forEach((link, index) => {
                const source = nodes.find(n => n.id === link.source);
                const target = nodes.find(n => n.id === link.target);
                
                svg.append('path')
                    .attr('id', `mech-td-path-${index}`)
                    .attr('d', `M${source.x},${source.y} L${target.x},${target.y}`)
                    .attr('fill', 'none')
                    .attr('stroke', '#adb5bd')
                    .attr('stroke-width', 1.5)
                    .attr('stroke-dasharray', '4,4');
            });
            
            const nodeGroup = svg.append('g').attr('class', 'nodes');
            nodes.forEach(node => {
                nodeGroup.append('circle')
                    .attr('cx', node.x)
                    .attr('cy', node.y)
                    .attr('r', node.size)
                    .attr('fill', node.color)
                    .attr('stroke', '#ffffff')
                    .attr('stroke-width', 2);
                
                nodeGroup.append('text')
                    .text(node.label)
                    .attr('x', node.x)
                    .attr('y', node.y + node.size + 15)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '10px')
                    .attr('fill', '#495057');
            });
            
            model.mechSimulation = { nodes: nodes, svg: svg, links: links };
            
            // Start rupee flow animations in mechanization view
            startMechFlowAnimations(svg, nodes, links, 'td');
        }

        function initBottomUpMechanization() {
            const model = MODELS.bu;
            const container = document.querySelector(model.mechContainer);
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            d3.select(model.mechContainer).select('svg').remove();
            
            const svg = d3.select(model.mechContainer).append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', `0 0 ${width} ${height}`);
            
            const nodes = [
                { id: 'households', label: 'Households', x: width * 0.15, y: height * 0.8, color: '#ff8f00', size: 18 },
                { id: 'essentials', label: 'Daily Essentials', x: width * 0.35, y: height * 0.7, color: '#ff8f00', size: 16 },
                { id: 'msme', label: 'MSMEs', x: width * 0.65, y: height * 0.7, color: '#00a152', size: 20 },
                { id: 'services', label: 'Local Services', x: width * 0.25, y: height * 0.4, color: '#00897b', size: 14 },
                { id: 'logistics', label: 'Logistics', x: width * 0.75, y: height * 0.4, color: '#00897b', size: 14 },
                { id: 'suppliers', label: 'Suppliers', x: width * 0.5, y: height * 0.2, color: '#1e88e5', size: 16 },
                { id: 'tax', label: 'Tax Pool', x: width * 0.9, y: height * 0.2, color: '#673ab7', size: 12 }
            ];
            
            const links = [
                { source: 'households', target: 'essentials' },
                { source: 'households', target: 'msme' },
                { source: 'essentials', target: 'msme' },
                { source: 'essentials', target: 'services' },
                { source: 'msme', target: 'logistics' },
                { source: 'msme', target: 'suppliers' },
                { source: 'services', target: 'suppliers' },
                { source: 'logistics', target: 'suppliers' },
                { source: 'suppliers', target: 'tax' },
                { source: 'msme', target: 'tax' }
            ];
            
            // Create pathways
            links.forEach((link, index) => {
                const source = nodes.find(n => n.id === link.source);
                const target = nodes.find(n => n.id === link.target);
                
                svg.append('path')
                    .attr('id', `mech-bu-path-${index}`)
                    .attr('d', `M${source.x},${source.y} L${target.x},${target.y}`)
                    .attr('fill', 'none')
                    .attr('stroke', '#adb5bd')
                    .attr('stroke-width', 1.5)
                    .attr('opacity', 0.8);
            });
            
            const nodeGroup = svg.append('g').attr('class', 'nodes');
            nodes.forEach(node => {
                nodeGroup.append('circle')
                    .attr('cx', node.x)
                    .attr('cy', node.y)
                    .attr('r', node.size)
                    .attr('fill', node.color)
                    .attr('stroke', '#ffffff')
                    .attr('stroke-width', 2);
                
                nodeGroup.append('text')
                    .text(node.label)
                    .attr('x', node.x)
                    .attr('y', node.y + node.size + 15)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '10px')
                    .attr('fill', '#495057');
            });
            
            model.mechSimulation = { nodes: nodes, svg: svg, links: links };
            
            // Start rupee flow animations in mechanization view
            startMechFlowAnimations(svg, nodes, links, 'bu');
        }

        function startMechFlowAnimations(svg, nodes, links, modelType) {
            const color = modelType === 'td' ? '#1e88e5' : '#ff8f00';
            const baseDuration = modelType === 'td' ? 3000 : 2000;
            
            function createMechFlow(linkIndex, delay = 0) {
                if (GLOBAL_STATE.cycleCompletePause) return;
                
                const link = links[linkIndex];
                const source = nodes.find(n => n.id === link.source);
                const target = nodes.find(n => n.id === link.target);
                
                const rupee = svg.append('text')
                    .attr('class', `mech-particle-${modelType}`)
                    .text('‚Çπ')
                    .attr('font-size', '12px')
                    .attr('fill', color)
                    .attr('opacity', 0)
                    .attr('x', source.x)
                    .attr('y', source.y)
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle');
                
                let startTime = Date.now();
                const duration = baseDuration + Math.random() * 1000;
                let isRemoved = false;
                
                function animate() {
                    if ((modelType === 'td' && !MODELS.td.running) || 
                        (modelType === 'bu' && !MODELS.bu.running) ||
                        !GLOBAL_STATE.isRunning || 
                        GLOBAL_STATE.cycleCompletePause || 
                        isRemoved) return;
                    
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    const x = source.x + (target.x - source.x) * progress;
                    const y = source.y + (target.y - source.y) * progress;
                    
                    rupee.attr('x', x)
                         .attr('y', y);
                    
                    // Fade in/out
                    if (progress < 0.2) {
                        rupee.attr('opacity', progress * 5);
                    } else if (progress > 0.8) {
                        rupee.attr('opacity', (1 - progress) * 5);
                    } else {
                        rupee.attr('opacity', 0.8);
                    }
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        isRemoved = true;
                        rupee.remove();
                        
                        // Create new flow
                        if (!GLOBAL_STATE.cycleCompletePause) {
                            setTimeout(() => {
                                createMechFlow(
                                    Math.floor(Math.random() * links.length),
                                    Math.random() * 2000
                                );
                            }, Math.random() * 2000);
                        }
                    }
                }
                
                setTimeout(() => {
                    if (!GLOBAL_STATE.cycleCompletePause) {
                        startTime = Date.now();
                        requestAnimationFrame(animate);
                    }
                }, delay);
            }
            
            // Start multiple flows
            for (let i = 0; i < (modelType === 'td' ? 3 : 4); i++) {
                createMechFlow(i % links.length, i * 600);
            }
        }

        function updateRupeeAnimations(modelType, progress) {
            const model = MODELS[modelType];
            
            // Update rupee opacity based on progress
            model.rupeeElements.forEach((rupee, index) => {
                const baseOpacity = 0.5 + (progress * 0.4);
                const pulseFactor = 0.1 * Math.sin(Date.now() / 1000 + index);
                rupee.attr('opacity', Math.min(baseOpacity + pulseFactor, 0.9));
            });
        }

        // ==================== ENHANCED FLOW NETWORK VISUALIZATION ====================

        const ENHANCED_NETWORKS = {
            td: {
                zoom: 1,
                transform: { x: 0, y: 0, k: 1 },
                isDetailed: false,
                simulation: null
            },
            bu: {
                zoom: 1,
                transform: { x: 0, y: 0, k: 1 },
                isDetailed: false,
                simulation: null
            }
        };

        // Define enhanced sectors with all missing economic sectors
        const ENHANCED_SECTOR_DATA = {
            td: [
                // Core sectors (visible in simplified view)
                { id: 'government', name: 'Government', type: 'core', x: 200, y: 150, size: 25, color: '#673ab7' },
                { id: 'financial', name: 'Financial System', type: 'core', x: 400, y: 150, size: 28, color: '#1e88e5' },
                { id: 'corporates', name: 'Large Corporations', type: 'core', x: 600, y: 150, size: 30, color: '#1565c0' },
                { id: 'infrastructure', name: 'Infrastructure', type: 'core', x: 400, y: 300, size: 26, color: '#00a152' },
                { id: 'manufacturing', name: 'Manufacturing', type: 'core', x: 600, y: 300, size: 24, color: '#00897b' },
                { id: 'households', name: 'Households', type: 'core', x: 200, y: 300, size: 22, color: '#ff8f00' },
                
                // Missing economic sectors (visible in detailed view)
                { id: 'export', name: 'Export Sector', type: 'missing', x: 700, y: 100, size: 18, color: '#4CAF50' },
                { id: 'import', name: 'Import Sector', type: 'missing', x: 100, y: 100, size: 18, color: '#F44336' },
                { id: 'real_estate', name: 'Real Estate', type: 'missing', x: 300, y: 400, size: 20, color: '#FF9800' },
                { id: 'construction', name: 'Construction', type: 'missing', x: 500, y: 400, size: 20, color: '#795548' },
                { id: 'technology', name: 'Technology', type: 'missing', x: 700, y: 200, size: 19, color: '#2196F3' },
                { id: 'digital', name: 'Digital Economy', type: 'missing', x: 700, y: 300, size: 18, color: '#3F51B5' },
                { id: 'education', name: 'Education', type: 'missing', x: 100, y: 200, size: 17, color: '#9C27B0' },
                { id: 'healthcare', name: 'Healthcare', type: 'missing', x: 100, y: 300, size: 17, color: '#E91E63' },
                { id: 'energy', name: 'Energy', type: 'missing', x: 300, y: 100, size: 19, color: '#FFC107' },
                { id: 'utilities', name: 'Utilities', type: 'missing', x: 300, y: 200, size: 18, color: '#00BCD4' },
                { id: 'transport', name: 'Transport', type: 'missing', x: 500, y: 100, size: 18, color: '#607D8B' },
                { id: 'logistics', name: 'Logistics', type: 'missing', x: 500, y: 200, size: 18, color: '#8BC34A' },
                
                // Sub-divisions within sectors
                { id: 'heavy_industry', name: 'Heavy Industry', type: 'sub', parent: 'manufacturing', x: 650, y: 350, size: 14, color: '#00695c' },
                { id: 'consumer_goods', name: 'Consumer Goods', type: 'sub', parent: 'manufacturing', x: 550, y: 350, size: 14, color: '#00897b' },
                { id: 'pharmaceuticals', name: 'Pharmaceuticals', type: 'sub', parent: 'manufacturing', x: 600, y: 400, size: 14, color: '#00a152' },
                { id: 'automotive', name: 'Automotive', type: 'sub', parent: 'manufacturing', x: 650, y: 250, size: 14, color: '#00695c' },
                { id: 'professional_services', name: 'Professional Services', type: 'sub', parent: 'corporates', x: 550, y: 100, size: 13, color: '#1565c0' },
                { id: 'hospitality', name: 'Hospitality', type: 'sub', parent: 'corporates', x: 550, y: 50, size: 13, color: '#1e88e5' },
                { id: 'entertainment', name: 'Entertainment', type: 'sub', parent: 'corporates', x: 650, y: 50, size: 13, color: '#2196F3' },
                { id: 'healthcare_services', name: 'Healthcare Services', type: 'sub', parent: 'healthcare', x: 50, y: 350, size: 12, color: '#E91E63' }
            ],
            bu: [
                // Core sectors for bottom-up
                { id: 'households', name: 'Households', type: 'core', x: 200, y: 150, size: 28, color: '#ff8f00' },
                { id: 'msme', name: 'MSMEs', type: 'core', x: 400, y: 150, size: 26, color: '#00a152' },
                { id: 'local_services', name: 'Local Services', type: 'core', x: 600, y: 150, size: 24, color: '#00897b' },
                { id: 'consumption', name: 'Consumption', type: 'core', x: 400, y: 300, size: 22, color: '#ff6f00' },
                { id: 'government', name: 'Government', type: 'core', x: 600, y: 300, size: 20, color: '#673ab7' },
                { id: 'agriculture', name: 'Agriculture', type: 'core', x: 200, y: 300, size: 23, color: '#689f38' },
                
                // Missing sectors for bottom-up
                { id: 'export_small', name: 'Small Exports', type: 'missing', x: 700, y: 100, size: 16, color: '#4CAF50' },
                { id: 'local_real_estate', name: 'Local Real Estate', type: 'missing', x: 100, y: 100, size: 17, color: '#FF9800' },
                { id: 'digital_msme', name: 'Digital MSMEs', type: 'missing', x: 700, y: 200, size: 16, color: '#2196F3' },
                { id: 'local_education', name: 'Local Education', type: 'missing', x: 100, y: 200, size: 15, color: '#9C27B0' },
                { id: 'local_healthcare', name: 'Local Healthcare', type: 'missing', x: 100, y: 300, size: 15, color: '#E91E63' },
                { id: 'renewable_energy', name: 'Renewable Energy', type: 'missing', x: 300, y: 100, size: 16, color: '#FFC107' },
                { id: 'local_transport', name: 'Local Transport', type: 'missing', x: 300, y: 200, size: 16, color: '#607D8B' },
                { id: 'local_logistics', name: 'Local Logistics', type: 'missing', x: 500, y: 100, size: 16, color: '#8BC34A' },
                
                // Sub-divisions
                { id: 'street_vendors', name: 'Street Vendors', type: 'sub', parent: 'msme', x: 350, y: 200, size: 12, color: '#00a152' },
                { id: 'home_businesses', name: 'Home Businesses', type: 'sub', parent: 'msme', x: 450, y: 200, size: 12, color: '#00a152' },
                { id: 'repair_services', name: 'Repair Services', type: 'sub', parent: 'local_services', x: 550, y: 200, size: 11, color: '#00897b' },
                { id: 'beauty_salons', name: 'Beauty Salons', type: 'sub', parent: 'local_services', x: 650, y: 200, size: 11, color: '#00897b' },
                { id: 'food_vendors', name: 'Food Vendors', type: 'sub', parent: 'consumption', x: 350, y: 350, size: 12, color: '#ff6f00' },
                { id: 'local_retail', name: 'Local Retail', type: 'sub', parent: 'consumption', x: 450, y: 350, size: 12, color: '#ff6f00' },
                { id: 'farmers', name: 'Farmers', type: 'sub', parent: 'agriculture', x: 150, y: 350, size: 13, color: '#689f38' },
                { id: 'fishermen', name: 'Fishermen', type: 'sub', parent: 'agriculture', x: 250, y: 350, size: 13, color: '#689f38' }
            ]
        };

        // Define connections
        const ENHANCED_CONNECTIONS = {
            td: [
                // Main flow
                { source: 'government', target: 'financial', strength: 0.9 },
                { source: 'financial', target: 'corporates', strength: 0.8 },
                { source: 'corporates', target: 'infrastructure', strength: 0.7 },
                { source: 'infrastructure', target: 'manufacturing', strength: 0.6 },
                { source: 'manufacturing', target: 'households', strength: 0.5 },
                { source: 'households', target: 'government', strength: 0.4 },
                
                // Missing sector connections
                { source: 'export', target: 'financial', strength: 0.3 },
                { source: 'financial', target: 'import', strength: 0.3 },
                { source: 'corporates', target: 'real_estate', strength: 0.4 },
                { source: 'real_estate', target: 'construction', strength: 0.5 },
                { source: 'corporates', target: 'technology', strength: 0.4 },
                { source: 'technology', target: 'digital', strength: 0.5 },
                { source: 'government', target: 'education', strength: 0.4 },
                { source: 'government', target: 'healthcare', strength: 0.4 },
                { source: 'infrastructure', target: 'energy', strength: 0.5 },
                { source: 'energy', target: 'utilities', strength: 0.6 },
                { source: 'infrastructure', target: 'transport', strength: 0.5 },
                { source: 'transport', target: 'logistics', strength: 0.6 },
                
                // Sub-division connections
                { source: 'manufacturing', target: 'heavy_industry', strength: 0.4 },
                { source: 'manufacturing', target: 'consumer_goods', strength: 0.4 },
                { source: 'manufacturing', target: 'pharmaceuticals', strength: 0.4 },
                { source: 'manufacturing', target: 'automotive', strength: 0.4 },
                { source: 'corporates', target: 'professional_services', strength: 0.3 },
                { source: 'corporates', target: 'hospitality', strength: 0.3 },
                { source: 'corporates', target: 'entertainment', strength: 0.3 },
                { source: 'healthcare', target: 'healthcare_services', strength: 0.4 }
            ],
            bu: [
                // Main flow
                { source: 'households', target: 'msme', strength: 0.9 },
                { source: 'msme', target: 'local_services', strength: 0.8 },
                { source: 'local_services', target: 'consumption', strength: 0.7 },
                { source: 'consumption', target: 'government', strength: 0.6 },
                { source: 'government', target: 'agriculture', strength: 0.5 },
                { source: 'agriculture', target: 'households', strength: 0.8 },
                
                // Missing sector connections
                { source: 'msme', target: 'export_small', strength: 0.3 },
                { source: 'households', target: 'local_real_estate', strength: 0.4 },
                { source: 'msme', target: 'digital_msme', strength: 0.4 },
                { source: 'households', target: 'local_education', strength: 0.3 },
                { source: 'households', target: 'local_healthcare', strength: 0.3 },
                { source: 'government', target: 'renewable_energy', strength: 0.4 },
                { source: 'local_services', target: 'local_transport', strength: 0.5 },
                { source: 'local_services', target: 'local_logistics', strength: 0.5 },
                
                // Sub-division connections
                { source: 'msme', target: 'street_vendors', strength: 0.6 },
                { source: 'msme', target: 'home_businesses', strength: 0.6 },
                { source: 'local_services', target: 'repair_services', strength: 0.5 },
                { source: 'local_services', target: 'beauty_salons', strength: 0.5 },
                { source: 'consumption', target: 'food_vendors', strength: 0.6 },
                { source: 'consumption', target: 'local_retail', strength: 0.6 },
                { source: 'agriculture', target: 'farmers', strength: 0.7 },
                { source: 'agriculture', target: 'fishermen', strength: 0.7 }
            ]
        };

        // Initialize enhanced network visualization
        function initEnhancedNetworkVisualization(modelType) {
            const container = document.getElementById(`${modelType}-enhanced-network`);
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Clear existing
            d3.select(`#${modelType}-enhanced-network svg`).remove();
            
            // Create SVG with zoom/pan capability
            const svg = d3.select(`#${modelType}-enhanced-network`)
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', `0 0 ${width} ${height}`)
                .attr('class', 'network-simplified');
            
            // Create zoomable group
            const g = svg.append('g')
                .attr('class', 'network-group');
            
            // Get data for this model
            const nodes = ENHANCED_SECTOR_DATA[modelType];
            const links = ENHANCED_CONNECTIONS[modelType];
            
            // Create links (paths)
            const linkGroup = g.append('g').attr('class', 'links');
            
            links.forEach(link => {
                const sourceNode = nodes.find(n => n.id === link.source);
                const targetNode = nodes.find(n => n.id === link.target);
                
                if (sourceNode && targetNode) {
                    // Create curved path
                    const path = d3.path();
                    const startX = sourceNode.x;
                    const startY = sourceNode.y;
                    const endX = targetNode.x;
                    const endY = targetNode.y;
                    
                    // Calculate control point for curve
                    const midX = (startX + endX) / 2;
                    const midY = (startY + endY) / 2;
                    const offset = 30;
                    const controlX = midX + (Math.random() - 0.5) * offset;
                    const controlY = midY + (Math.random() - 0.5) * offset;
                    
                    path.moveTo(startX, startY);
                    path.quadraticCurveTo(controlX, controlY, endX, endY);
                    
                    linkGroup.append('path')
                        .attr('class', 'network-link-enhanced')
                        .attr('id', `link-${link.source}-${link.target}`)
                        .attr('d', path.toString())
                        .attr('stroke', modelType === 'td' ? '#1e88e5' : '#ff8f00')
                        .attr('stroke-width', link.strength * 3)
                        .attr('stroke-opacity', 0.3)
                        .on('mouseenter', function(event) {
                            d3.select(this)
                                .transition()
                                .duration(200)
                                .attr('stroke-opacity', 0.8)
                                .attr('stroke-width', link.strength * 5);
                        })
                        .on('mouseleave', function() {
                            d3.select(this)
                                .transition()
                                .duration(200)
                                .attr('stroke-opacity', 0.3)
                                .attr('stroke-width', link.strength * 3);
                        });
                }
            });
            
            // Create nodes
            const nodeGroup = g.append('g').attr('class', 'nodes');
            
            nodes.forEach(node => {
                const nodeClass = `network-node-enhanced ${node.type === 'missing' ? node.id.replace('_', '-') + '-node' : ''}`;
                
                const nodeCircle = nodeGroup.append('circle')
                    .attr('class', nodeClass)
                    .attr('id', `node-${node.id}`)
                    .attr('cx', node.x)
                    .attr('cy', node.y)
                    .attr('r', node.size)
                    .attr('fill', node.color)
                    .attr('stroke', 'white')
                    .attr('stroke-width', 2)
                    .style('cursor', 'pointer')
                    .on('mouseenter', function(event) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr('stroke-width', 4)
                            .attr('stroke', '#ff8f00');
                        
                        showNetworkTooltip(node, event.pageX, event.pageY);
                    })
                    .on('mouseleave', function() {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr('stroke-width', 2)
                            .attr('stroke', 'white');
                        
                        hideNetworkTooltip();
                    })
                    .on('click', function() {
                        highlightConnectedNodes(node.id, modelType);
                    });
                
                // Add label
                nodeGroup.append('text')
                    .attr('class', 'sector-label-enhanced')
                    .attr('x', node.x)
                    .attr('y', node.y + node.size + 15)
                    .text(node.name)
                    .attr('font-size', node.type === 'core' ? '0.9rem' : '0.8rem')
                    .attr('fill', '#495057');
            });
            
            // Create sub-sector links (dashed)
            const subLinkGroup = g.append('g').attr('class', 'sub-sector-links');
            
            nodes.filter(n => n.type === 'sub').forEach(subNode => {
                const parentNode = nodes.find(n => n.id === subNode.parent);
                if (parentNode) {
                    subLinkGroup.append('line')
                        .attr('class', 'sub-sector-link')
                        .attr('x1', parentNode.x)
                        .attr('y1', parentNode.y)
                        .attr('x2', subNode.x)
                        .attr('y2', subNode.y)
                        .attr('stroke', '#adb5bd')
                        .attr('stroke-width', 1)
                        .attr('stroke-dasharray', '3,3');
                }
            });
            
            // Store simulation
            ENHANCED_NETWORKS[modelType].simulation = { svg: svg, g: g, nodes: nodes, links: links };
            
            // Initialize rupee flow on network
            startEnhancedNetworkRupeeFlow(modelType, svg, nodes, links);
            
            // Setup zoom behavior
            setupNetworkZoom(modelType, svg, g);
        }

        // Network zoom functionality
        function setupNetworkZoom(modelType, svg, g) {
            const zoom = d3.zoom()
                .scaleExtent([0.5, 3])
                .on('zoom', function(event) {
                    g.attr('transform', event.transform);
                    ENHANCED_NETWORKS[modelType].transform = event.transform;
                    updateZoomLevel(modelType, event.transform.k);
                });
            
            svg.call(zoom);
        }

        function zoomNetwork(modelType, action) {
            const network = ENHANCED_NETWORKS[modelType];
            const svg = d3.select(`#${modelType}-enhanced-network svg`);
            
            let newK = network.transform.k;
            
            switch(action) {
                case 'in':
                    newK = Math.min(3, network.transform.k * 1.2);
                    break;
                case 'out':
                    newK = Math.max(0.5, network.transform.k * 0.8);
                    break;
                case 'reset':
                    newK = 1;
                    break;
            }
            
            const transform = d3.zoomIdentity
                .translate(network.transform.x, network.transform.y)
                .scale(newK);
            
            svg.transition()
                .duration(300)
                .call(d3.zoom().transform, transform);
        }

        function updateZoomLevel(modelType, level) {
            document.querySelector(`#${modelType}-enhanced-network .zoom-level`).textContent = 
                `Zoom: ${Math.round(level * 100)}%`;
        }

        function toggleNetworkDetail(modelType) {
            const network = ENHANCED_NETWORKS[modelType];
            const svg = d3.select(`#${modelType}-enhanced-network svg`);
            
            network.isDetailed = !network.isDetailed;
            
            if (network.isDetailed) {
                svg.attr('class', 'network-detailed');
                // Show all nodes and links
                svg.selectAll('.sub-sector-node, .sub-sector-link').style('display', 'block');
                svg.selectAll('.network-link-enhanced')
                    .transition()
                    .duration(300)
                    .attr('stroke-width', d => d.strength * 4)
                    .attr('stroke-opacity', 0.6);
            } else {
                svg.attr('class', 'network-simplified');
                // Hide sub-sectors
                svg.selectAll('.sub-sector-node, .sub-sector-link').style('display', 'none');
                svg.selectAll('.network-link-enhanced')
                    .transition()
                    .duration(300)
                    .attr('stroke-width', d => d.strength * 2)
                    .attr('stroke-opacity', 0.3);
            }
        }

        // Network tooltip
        const networkTooltip = d3.select('body')
            .append('div')
            .attr('class', 'network-tooltip')
            .style('opacity', 0);

        function showNetworkTooltip(node, x, y) {
            const sectorType = node.type === 'core' ? 'Core Sector' : 
                              node.type === 'missing' ? 'Missing Sector' : 'Sub-Sector';
            
            const content = `
                <div style="font-weight:600;margin-bottom:5px;">${node.name}</div>
                <div style="font-size:0.8rem;color:#ddd;margin-bottom:3px;">${sectorType}</div>
                <div style="font-size:0.8rem;">Size: ${node.size}px</div>
                <div style="font-size:0.8rem;">Capital Flow: ${Math.round(node.size * 10000)}</div>
            `;
            
            networkTooltip.html(content)
                .style('left', (x + 15) + 'px')
                .style('top', (y - 15) + 'px')
                .transition()
                .duration(200)
                .style('opacity', 1);
        }

        function hideNetworkTooltip() {
            networkTooltip.transition()
                .duration(200)
                .style('opacity', 0);
        }

        // Highlight connected nodes
        function highlightConnectedNodes(nodeId, modelType) {
            const network = ENHANCED_NETWORKS[modelType];
            const links = ENHANCED_CONNECTIONS[modelType];
            
            // Reset all nodes
            d3.selectAll(`#${modelType}-enhanced-network .network-node-enhanced`)
                .transition()
                .duration(300)
                .attr('stroke-width', 2)
                .attr('stroke', 'white');
            
            // Highlight connected nodes
            const connectedNodes = new Set();
            connectedNodes.add(nodeId);
            
            links.forEach(link => {
                if (link.source === nodeId) {
                    connectedNodes.add(link.target);
                }
                if (link.target === nodeId) {
                    connectedNodes.add(link.source);
                }
            });
            
            connectedNodes.forEach(connectedId => {
                d3.select(`#${modelType}-enhanced-network #node-${connectedId}`)
                    .transition()
                    .duration(300)
                    .attr('stroke-width', 4)
                    .attr('stroke', '#00a152');
            });
        }

        // Enhanced rupee flow on network
        function startEnhancedNetworkRupeeFlow(modelType, svg, nodes, links) {
            const rupeeElements = [];
            const flowColor = modelType === 'td' ? '#1e88e5' : '#ff8f00';
            
            function createNetworkRupee(linkIndex, delay = 0) {
                if (GLOBAL_STATE.cycleCompletePause) return;
                
                const link = links[linkIndex];
                const sourceNode = nodes.find(n => n.id === link.source);
                const targetNode = nodes.find(n => n.id === link.target);
                
                if (!sourceNode || !targetNode) return;
                
                // Get the path element
                const pathElement = svg.select(`#link-${link.source}-${link.target}`);
                if (pathElement.empty()) return;
                
                const pathLength = pathElement.node().getTotalLength();
                const monthProgress = SYNCHRONIZED_TIMELINE.currentMonth / 36;
                const flowSpeed = 2000 + (monthProgress * 1000);
                const rupeeSize = 12 + (monthProgress * 4);
                
                // Create rupee
                const rupee = svg.append('text')
                    .attr('class', 'flow-rupee-enhanced')
                    .text('‚Çπ')
                    .attr('font-size', `${rupeeSize}px`)
                    .attr('fill', flowColor)
                    .attr('font-weight', '700')
                    .attr('opacity', 0)
                    .attr('x', sourceNode.x)
                    .attr('y', sourceNode.y)
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle');
                
                rupeeElements.push(rupee);
                
                let startTime = Date.now();
                let isActive = true;
                
                function animate() {
                    if (!GLOBAL_STATE.isRunning || !isActive || GLOBAL_STATE.cycleCompletePause) {
                        isActive = false;
                        rupee.remove();
                        return;
                    }
                    
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / flowSpeed, 1);
                    
                    // Get point along path
                    const point = pathElement.node().getPointAtLength(progress * pathLength);
                    
                    // Apply zoom transform
                    const network = ENHANCED_NETWORKS[modelType];
                    const transformedX = point.x * network.transform.k + network.transform.x;
                    const transformedY = point.y * network.transform.k + network.transform.y;
                    
                    rupee.attr('x', transformedX)
                         .attr('y', transformedY);
                    
                    // Sophisticated opacity
                    if (progress < 0.1) {
                        rupee.attr('opacity', progress * 10);
                    } else if (progress > 0.9) {
                        rupee.attr('opacity', (1 - progress) * 10);
                    } else {
                        const pulse = 0.05 * Math.sin(Date.now() / 200);
                        rupee.attr('opacity', 0.85 + pulse);
                    }
                    
                    // Scale with progress
                    const scale = 1 + 0.1 * Math.sin(progress * Math.PI);
                    rupee.style('transform', `scale(${scale})`);
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        // Enter bubble animation
                        rupee.transition()
                            .duration(150)
                            .attr('opacity', 0)
                            .attr('font-size', `${rupeeSize * 0.7}px`)
                            .on('end', function() {
                                isActive = false;
                                rupee.remove();
                                
                                const index = rupeeElements.indexOf(rupee);
                                if (index > -1) rupeeElements.splice(index, 1);
                                
                                // Continue flow
                                if (GLOBAL_STATE.isRunning && !GLOBAL_STATE.cycleCompletePause) {
                                    setTimeout(() => {
                                        // Find next connection from this target
                                        const outgoingLinks = links.filter(l => l.source === link.target);
                                        if (outgoingLinks.length > 0) {
                                            const nextLink = outgoingLinks[Math.floor(Math.random() * outgoingLinks.length)];
                                            const nextLinkIndex = links.indexOf(nextLink);
                                            createNetworkRupee(nextLinkIndex, Math.random() * 200);
                                        }
                                    }, 100 + Math.random() * 200);
                                }
                            });
                    }
                }
                
                setTimeout(() => {
                    if (GLOBAL_STATE.isRunning && !GLOBAL_STATE.cycleCompletePause) {
                        startTime = Date.now();
                        requestAnimationFrame(animate);
                    }
                }, delay);
            }
            
            // Start initial flows
            for (let i = 0; i < 4; i++) {
                setTimeout(() => {
                    createNetworkRupee(i % links.length, 0);
                }, i * 300);
            }
            
            // Dynamic flow management
            setInterval(() => {
                if (!GLOBAL_STATE.isRunning || GLOBAL_STATE.cycleCompletePause || rupeeElements.length >= 8) return;
                
                const monthProgress = SYNCHRONIZED_TIMELINE.currentMonth / 36;
                const targetCount = 3 + Math.floor(monthProgress * 5);
                
                if (rupeeElements.length < targetCount) {
                    createNetworkRupee(Math.floor(Math.random() * links.length), 0);
                }
            }, 2500);
            
            return rupeeElements;
        }

        // ==================== GOD-LEVEL PIE CHART ====================

        const PIE_CONFIG = {
            td: {
                currentView: 'sectors',
                animationSpeed: 1,
                colors: {
                    'Government': '#673ab7',
                    'Corporates': '#1e88e5',
                    'Infrastructure': '#00a152',
                    'Manufacturing': '#00897b',
                    'Households': '#ff8f00',
                    'Financial': '#3949ab',
                    'Agriculture': '#689f38',
                    'Export': '#4CAF50',
                    'Import': '#F44336',
                    'Real Estate': '#FF9800',
                    'Technology': '#2196F3',
                    'Education': '#9C27B0',
                    'Healthcare': '#E91E63',
                    'Energy': '#FFC107',
                    'Transport': '#607D8B'
                },
                chart: null
            },
            bu: {
                currentView: 'sectors',
                animationSpeed: 1,
                colors: {
                    'Households': '#ff8f00',
                    'MSMEs': '#00a152',
                    'Local Services': '#00897b',
                    'Consumption': '#ff6f00',
                    'Government': '#673ab7',
                    'Agriculture': '#689f38',
                    'Local Real Estate': '#FF9800',
                    'Digital MSMEs': '#2196F3',
                    'Local Education': '#9C27B0',
                    'Local Healthcare': '#E91E63',
                    'Renewable Energy': '#FFC107',
                    'Local Transport': '#607D8B',
                    'Street Vendors': '#4CAF50',
                    'Home Businesses': '#8BC34A'
                },
                chart: null
            }
        };

        // Initialize pie charts
        function initPieCharts() {
            createPieChart('td');
            createPieChart('bu');
            
            // Start animation loop
            setInterval(() => {
                updatePieCharts();
            }, 100);
        }

        function createPieChart(modelType) {
            const container = document.getElementById(`${modelType}-pie-svg-container`);
            const width = container.clientWidth;
            const height = 350;
            
            // Create SVG
            const svg = d3.select(`#${modelType}-pie-svg-container`)
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', `0 0 ${width} ${height}`)
                .attr('preserveAspectRatio', 'xMidYMid meet');
            
            // Create tooltip
            const tooltip = d3.select('body')
                .append('div')
                .attr('class', 'pie-tooltip')
                .style('opacity', 0);
            
            // Store reference
            PIE_CONFIG[modelType].svg = svg;
            PIE_CONFIG[modelType].tooltip = tooltip;
            PIE_CONFIG[modelType].width = width;
            PIE_CONFIG[modelType].height = height;
            
            // Initial render
            updatePieChartData(modelType);
        }

        function updatePieChartData(modelType) {
            const config = PIE_CONFIG[modelType];
            const progress = Math.min(SYNCHRONIZED_TIMELINE.currentMonth / 36, 1);
            
            // Generate data based on current view and progress
            let data;
            
            switch(config.currentView) {
                case 'sectors':
                    data = getSectorData(modelType, progress);
                    break;
                case 'subsectors':
                    data = getSubSectorData(modelType, progress);
                    break;
                case 'flow':
                    data = getFlowData(modelType, progress);
                    break;
            }
            
            // Calculate total for percentages
            const total = d3.sum(data, d => d.value);
            
            // Update pie chart visualization
            renderPieChart(modelType, data, total);
            updatePieLegend(modelType, data, total);
        }

        function getSectorData(modelType, progress) {
            if (modelType === 'td') {
                return [
                    { name: 'Government', value: 300000000 * progress },
                    { name: 'Corporates', value: 7000000000 * (1 - progress * 0.5) },
                    { name: 'Infrastructure', value: 4000000000 * progress },
                    { name: 'Manufacturing', value: 2500000000 * progress },
                    { name: 'Households', value: progress * 3000000000 },
                    { name: 'Financial', value: 1500000000 * (1 - progress * 0.8) },
                    { name: 'Agriculture', value: progress * 500000000 }
                ];
            } else {
                return [
                    { name: 'Households', value: 5800000000 * (1 - progress * 0.8) },
                    { name: 'MSMEs', value: 4200000000 * (1 - progress * 0.6) },
                    { name: 'Local Services', value: progress * 2000000000 },
                    { name: 'Consumption', value: progress * 3500000000 },
                    { name: 'Government', value: progress * 1200000000 },
                    { name: 'Agriculture', value: progress * 800000000 }
                ];
            }
        }

        function getSubSectorData(modelType, progress) {
            if (modelType === 'td') {
                return [
                    { name: 'Heavy Industry', value: 800000000 * progress },
                    { name: 'Consumer Goods', value: 600000000 * progress },
                    { name: 'Pharmaceuticals', value: 400000000 * progress },
                    { name: 'Automotive', value: 700000000 * progress },
                    { name: 'Professional Services', value: 300000000 * progress },
                    { name: 'Hospitality', value: 250000000 * progress },
                    { name: 'Entertainment', value: 200000000 * progress },
                    { name: 'Healthcare Services', value: 350000000 * progress }
                ];
            } else {
                return [
                    { name: 'Street Vendors', value: 600000000 * progress },
                    { name: 'Home Businesses', value: 400000000 * progress },
                    { name: 'Repair Services', value: 300000000 * progress },
                    { name: 'Beauty Salons', value: 200000000 * progress },
                    { name: 'Food Vendors', value: 500000000 * progress },
                    { name: 'Local Retail', value: 400000000 * progress },
                    { name: 'Farmers', value: 600000000 * progress },
                    { name: 'Fishermen', value: 200000000 * progress }
                ];
            }
        }

        function getFlowData(modelType, progress) {
            // Shows direction of flow
            if (modelType === 'td') {
                return [
                    { name: 'Government ‚Üí Financial', value: 0.9 * progress },
                    { name: 'Financial ‚Üí Corporates', value: 0.8 * progress },
                    { name: 'Corporates ‚Üí Infrastructure', value: 0.7 * progress },
                    { name: 'Infrastructure ‚Üí Manufacturing', value: 0.6 * progress },
                    { name: 'Manufacturing ‚Üí Households', value: 0.5 * progress },
                    { name: 'Households ‚Üí Government', value: 0.4 * progress }
                ];
            } else {
                return [
                    { name: 'Households ‚Üí MSMEs', value: 0.9 * progress },
                    { name: 'MSMEs ‚Üí Local Services', value: 0.8 * progress },
                    { name: 'Local Services ‚Üí Consumption', value: 0.7 * progress },
                    { name: 'Consumption ‚Üí Government', value: 0.6 * progress },
                    { name: 'Government ‚Üí Agriculture', value: 0.5 * progress },
                    { name: 'Agriculture ‚Üí Households', value: 0.8 * progress }
                ];
            }
        }

        function renderPieChart(modelType, data, total) {
            const config = PIE_CONFIG[modelType];
            const svg = config.svg;
            const width = config.width;
            const height = config.height;
            const radius = Math.min(width, height) / 2.5;
            const centerX = width / 2;
            const centerY = height / 2;
            
            // Clear existing
            svg.selectAll('*').remove();
            
            // Create pie layout
            const pie = d3.pie()
                .value(d => d.value)
                .sort(null)
                .padAngle(0.01);
            
            const arc = d3.arc()
                .innerRadius(radius * 0.6)
                .outerRadius(radius);
            
            const arcs = pie(data);
            
            // Create group
            const g = svg.append('g')
                .attr('transform', `translate(${centerX}, ${centerY})`);
            
            // Create slices with smooth animation
            const slices = g.selectAll('.pie-slice-master')
                .data(arcs)
                .enter().append('path')
                .attr('class', 'pie-slice-master')
                .attr('fill', d => config.colors[d.data.name] || '#cccccc')
                .attr('d', arc)
                .attr('stroke', 'white')
                .attr('stroke-width', 2)
                .style('opacity', 0.9)
                .on('mouseenter', function(event, d) {
                    // Highlight slice
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('stroke-width', 4)
                        .style('opacity', 1);
                    
                    // Show tooltip
                    const percentage = ((d.data.value / total) * 100).toFixed(1);
                    const tooltipContent = `
                        <div class="pie-tooltip-title">${d.data.name}</div>
                        <div class="pie-tooltip-value">‚Çπ${(d.data.value/10000000).toFixed(1)}Cr</div>
                        <div class="pie-tooltip-percentage">${percentage}% of total</div>
                    `;
                    
                    config.tooltip.html(tooltipContent)
                        .style('left', (event.pageX + 15) + 'px')
                        .style('top', (event.pageY - 15) + 'px')
                        .transition()
                        .duration(200)
                        .style('opacity', 1);
                })
                .on('mouseleave', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('stroke-width', 2)
                        .style('opacity', 0.9);
                    
                    config.tooltip.transition()
                        .duration(200)
                        .style('opacity', 0);
                })
                .on('mousemove', function(event) {
                    config.tooltip
                        .style('left', (event.pageX + 15) + 'px')
                        .style('top', (event.pageY - 15) + 'px');
                });
            
            // Animate slices with smooth entrance
            slices.transition()
                .duration(1000 * config.animationSpeed)
                .ease(d3.easeCubicOut)
                .attrTween('d', function(d) {
                    const interpolate = d3.interpolate({ startAngle: 0, endAngle: 0 }, d);
                    return function(t) {
                        return arc(interpolate(t));
                    };
                });
            
            // Add labels for larger slices
            g.selectAll('.pie-label-master')
                .data(arcs.filter(d => (d.endAngle - d.startAngle) > 0.2))
                .enter().append('text')
                .attr('class', 'pie-label-master')
                .attr('transform', d => {
                    const pos = arc.centroid(d);
                    const midAngle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                    const x = Math.cos(midAngle) * (radius * 0.8);
                    const y = Math.sin(midAngle) * (radius * 0.8);
                    return `translate(${x}, ${y})`;
                })
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle')
                .text(d => {
                    const percentage = ((d.data.value / total) * 100).toFixed(0);
                    return percentage >= 5 ? `${percentage}%` : '';
                })
                .attr('font-size', '0.85rem')
                .style('opacity', 0)
                .transition()
                .delay(800 * config.animationSpeed)
                .duration(300 * config.animationSpeed)
                .style('opacity', 1);
            
            // Add center circle
            g.append('circle')
                .attr('class', 'pie-center')
                .attr('cx', 0)
                .attr('cy', 0)
                .attr('r', radius * 0.55)
                .style('opacity', 0)
                .transition()
                .delay(600 * config.animationSpeed)
                .duration(400 * config.animationSpeed)
                .style('opacity', 1);
            
            // Add center text
            g.append('text')
                .attr('class', 'pie-center-text')
                .attr('x', 0)
                .attr('y', 0)
                .text(`‚Çπ${(total/10000000).toFixed(1)}Cr`)
                .style('opacity', 0)
                .transition()
                .delay(800 * config.animationSpeed)
                .duration(400 * config.animationSpeed)
                .style('opacity', 1);
            
            // Add subtle animation pulse
            setInterval(() => {
                if (GLOBAL_STATE.isRunning && !GLOBAL_STATE.cycleCompletePause) {
                    slices.each(function(d, i) {
                        const pulse = 0.02 * Math.sin(Date.now() / 2000 + i);
                        d3.select(this)
                            .transition()
                            .duration(500)
                            .style('opacity', 0.9 + pulse);
                    });
                }
            }, 100);
        }

        function updatePieLegend(modelType, data, total) {
            const legendContainer = document.getElementById(`${modelType}-pie-legend`);
            const config = PIE_CONFIG[modelType];
            
            // Clear existing
            legendContainer.innerHTML = '';
            
            // Add title
            const title = document.createElement('div');
            title.className = 'legend-title';
            title.textContent = 'Sector Breakdown';
            legendContainer.appendChild(title);
            
            // Add legend items
            data.forEach(item => {
                const percentage = ((item.value / total) * 100).toFixed(1);
                
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.onclick = () => highlightPieSlice(modelType, item.name);
                
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${config.colors[item.name] || '#cccccc'}"></div>
                    <div class="legend-text">${item.name}</div>
                    <div class="legend-value">‚Çπ${(item.value/10000000).toFixed(1)}Cr</div>
                    <div class="legend-percentage">${percentage}%</div>
                `;
                
                legendContainer.appendChild(legendItem);
            });
        }

        function highlightPieSlice(modelType, sliceName) {
            const config = PIE_CONFIG[modelType];
            const svg = config.svg;
            
            // Reset all slices
            svg.selectAll('.pie-slice-master')
                .transition()
                .duration(300)
                .attr('stroke-width', 2)
                .style('opacity', 0.9);
            
            // Highlight selected slice
            svg.selectAll('.pie-slice-master')
                .filter(d => d.data.name === sliceName)
                .transition()
                .duration(300)
                .attr('stroke-width', 5)
                .attr('stroke', '#ff8f00')
                .style('opacity', 1);
        }

        function changePieView(modelType, view) {
            const config = PIE_CONFIG[modelType];
            
            // Update active button
            d3.selectAll(`#${modelType}-pie-master .pie-control-btn`)
                .classed('active', false);
            
            d3.select(`#${modelType}-pie-master .pie-control-btn:contains("${view.charAt(0).toUpperCase() + view.slice(1)}")`)
                .classed('active', true);
            
            // Change view
            config.currentView = view;
            updatePieChartData(modelType);
        }

        function changeAnimationSpeed(modelType, event) {
            const config = PIE_CONFIG[modelType];
            const rect = event.target.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = clickX / rect.width;
            
            // Update speed (0.5x to 2x)
            config.animationSpeed = 0.5 + (percentage * 1.5);
            
            // Update UI
            const fillElement = document.getElementById(`${modelType}-speed-fill`);
            const labelElement = document.getElementById(`${modelType}-speed-label`);
            
            fillElement.style.width = `${percentage * 100}%`;
            
            let speedLabel;
            if (config.animationSpeed < 0.8) speedLabel = 'Slow';
            else if (config.animationSpeed < 1.2) speedLabel = 'Normal';
            else speedLabel = 'Fast';
            
            labelElement.textContent = `Speed: ${speedLabel}`;
        }

        function updatePieCharts() {
            if (!GLOBAL_STATE.isRunning || GLOBAL_STATE.cycleCompletePause) return;
            
            updatePieChartData('td');
            updatePieChartData('bu');
        }

        // ==================== MONTH-BASED RUPPEE ORIGIN FLOW ====================

        function updateRupeeFlowBasedOnMonth() {
            const currentMonth = Math.floor(SYNCHRONIZED_TIMELINE.currentMonth);
            const monthProgress = SYNCHRONIZED_TIMELINE.currentMonth / 36;
            
            // Update top-down rupee flow based on month phase
            if (MODELS.td.simulation && MODELS.td.running) {
                updateTDRupeeFlow(currentMonth, monthProgress);
            }
            
            // Update bottom-up rupee flow based on month phase
            if (MODELS.bu.simulation && MODELS.bu.running) {
                updateBURupeeFlow(currentMonth, monthProgress);
            }
        }

        function updateTDRupeeFlow(currentMonth, progress) {
            const model = MODELS.td;
            const simulation = model.simulation;
            if (!simulation) return;
            
            const sectors = simulation.sectors;
            const center = simulation.center;
            const radius = simulation.radius;
            
            // Determine flow pattern based on month
            let flowPattern;
            
            if (currentMonth < 9) {
                // Phase 1: Capital Deployment - Heavy flow from Government to Financial
                flowPattern = [
                    { from: 'government', to: 'capital', intensity: 0.8 },
                    { from: 'capital', to: 'corporates', intensity: 0.7 },
                    { from: 'corporates', to: 'production', intensity: 0.6 }
                ];
            } else if (currentMonth < 18) {
                // Phase 2: Construction - Flow through production chain
                flowPattern = [
                    { from: 'corporates', to: 'production', intensity: 0.9 },
                    { from: 'production', to: 'wages', intensity: 0.8 },
                    { from: 'wages', to: 'consumption', intensity: 0.7 }
                ];
            } else if (currentMonth < 27) {
                // Phase 3: Operations - Full circular flow
                flowPattern = [
                    { from: 'production', to: 'wages', intensity: 0.8 },
                    { from: 'wages', to: 'consumption', intensity: 0.9 },
                    { from: 'consumption', to: 'government', intensity: 0.7 },
                    { from: 'government', to: 'capital', intensity: 0.6 }
                ];
            } else {
                // Phase 4: Maturity - Balanced flow
                flowPattern = [
                    { from: 'government', to: 'capital', intensity: 0.7 },
                    { from: 'capital', to: 'corporates', intensity: 0.8 },
                    { from: 'corporates', to: 'production', intensity: 0.9 },
                    { from: 'production', to: 'wages', intensity: 0.8 },
                    { from: 'wages', to: 'consumption', intensity: 0.9 },
                    { from: 'consumption', to: 'government', intensity: 0.7 }
                ];
            }
            
            // Adjust flow count based on progress
            const targetFlowCount = 2 + Math.floor(progress * 6);
            
            // Ensure we have enough flows
            while (model.flowParticles.length < targetFlowCount && flowPattern.length > 0) {
                const pattern = flowPattern[Math.floor(Math.random() * flowPattern.length)];
                const fromIndex = sectors.findIndex(s => s.id === pattern.from);
                const toIndex = sectors.findIndex(s => s.id === pattern.to);
                
                if (fromIndex !== -1 && toIndex !== -1) {
                    createMonthBasedRupeeFlow('td', fromIndex, pattern.intensity);
                }
            }
        }

        function updateBURupeeFlow(currentMonth, progress) {
            const model = MODELS.bu;
            const simulation = model.simulation;
            if (!simulation) return;
            
            const sectors = simulation.sectors;
            const connections = simulation.connections;
            
            // Bottom-up flow patterns based on month
            let activeConnections = [];
            
            if (currentMonth < 9) {
                // Phase 1: Immediate Consumption - Households to MSMEs
                activeConnections = connections.filter((conn, i) => {
                    const source = sectors[conn[0]];
                    const target = sectors[conn[1]];
                    return (source.id === 'households' && target.id === 'msme') ||
                           (source.id === 'msme' && target.id === 'services');
                });
            } else if (currentMonth < 18) {
                // Phase 2: Network Effects - All connections
                activeConnections = connections;
            } else if (currentMonth < 27) {
                // Phase 3: Market Integration - Focus on services and production
                activeConnections = connections.filter((conn, i) => {
                    const source = sectors[conn[0]];
                    const target = sectors[conn[1]];
                    return source.id.includes('service') || target.id.includes('service') ||
                           source.id.includes('production') || target.id.includes('production');
                });
            } else {
                // Phase 4: Ecosystem Maturity - Full network
                activeConnections = connections;
            }
            
            // Adjust flow count
            const targetFlowCount = 3 + Math.floor(progress * 7);
            
            // Create flows
            while (model.flowParticles.length < targetFlowCount && activeConnections.length > 0) {
                const connIndex = Math.floor(Math.random() * activeConnections.length);
                createMonthBasedNetworkFlow('bu', connIndex, 0.8);
            }
        }

        function createMonthBasedRupeeFlow(modelType, sectorIndex, intensity) {
            const model = MODELS[modelType];
            const simulation = model.simulation;
            if (!simulation || GLOBAL_STATE.cycleCompletePause) return;
            
            const sectors = simulation.sectors;
            const center = simulation.center;
            const radius = simulation.radius;
            const svg = simulation.svg;
            
            const startSector = sectors[sectorIndex];
            const endSector = sectors[(sectorIndex + 1) % sectors.length];
            
            // Perfect circular arc
            const startAngle = startSector.angle;
            const endAngle = endSector.angle + (endSector.angle < startAngle ? 2*Math.PI : 0);
            const arcRadius = radius * 1.05;
            
            const rupee = svg.append('text')
                .attr('class', 'flow-rupee-real')
                .text('‚Çπ')
                .attr('font-size', `${14 + (intensity * 6)}px`)
                .attr('fill', modelType === 'td' ? '#1e88e5' : '#ff8f00')
                .attr('font-weight', '700')
                .attr('opacity', 0)
                .attr('x', startSector.x)
                .attr('y', startSector.y)
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle');
            
            model.rupeeElements.push(rupee);
            
            const flowSpeed = 2000 / intensity;
            let startTime = Date.now();
            let isActive = true;
            
            function animate() {
                if (!model.running || !GLOBAL_STATE.isRunning || !isActive || GLOBAL_STATE.cycleCompletePause) {
                    isActive = false;
                    rupee.remove();
                    return;
                }
                
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / flowSpeed, 1);
                
                const currentAngle = startAngle + (endAngle - startAngle) * progress;
                const x = center.x + arcRadius * Math.cos(currentAngle);
                const y = center.y + arcRadius * Math.sin(currentAngle);
                
                rupee.attr('x', x).attr('y', y);
                
                // Sophisticated opacity
                if (progress < 0.1) {
                    rupee.attr('opacity', progress * 10);
                } else if (progress > 0.9) {
                    rupee.attr('opacity', (1 - progress) * 10);
                } else {
                    const pulse = 0.05 * Math.sin(Date.now() / 250 + sectorIndex);
                    rupee.attr('opacity', 0.85 + pulse);
                }
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    // Enter bubble
                    rupee.transition()
                        .duration(200)
                        .attr('opacity', 0)
                        .attr('font-size', `${(14 + (intensity * 6)) * 0.7}px`)
                        .on('end', function() {
                            isActive = false;
                            rupee.remove();
                            
                            const index = model.rupeeElements.indexOf(rupee);
                            if (index > -1) model.rupeeElements.splice(index, 1);
                            
                            // Continue if still running
                            if (model.running && GLOBAL_STATE.isRunning && !GLOBAL_STATE.cycleCompletePause) {
                                setTimeout(() => {
                                    createMonthBasedRupeeFlow(modelType, (sectorIndex + 1) % sectors.length, intensity * 0.9);
                                }, 100 + Math.random() * 200);
                            }
                        });
                }
            }
            
            startTime = Date.now();
            requestAnimationFrame(animate);
        }

        function createMonthBasedNetworkFlow(modelType, connectionIndex, intensity) {
            const model = MODELS[modelType];
            const simulation = model.simulation;
            if (!simulation || GLOBAL_STATE.cycleCompletePause) return;
            
            const sectors = simulation.sectors;
            const connections = simulation.connections;
            const center = simulation.center;
            const radius = simulation.radius;
            const svg = simulation.svg;
            
            const conn = connections[connectionIndex];
            const source = sectors[conn[0]];
            const target = sectors[conn[1]];
            
            const startAngle = source.angle;
            const endAngle = target.angle + (target.angle < startAngle ? 2*Math.PI : 0);
            const midAngle = (startAngle + endAngle) / 2;
            const midRadius = radius * 1.1 + (connectionIndex % 3) * 10;
            const midX = center.x + midRadius * Math.cos(midAngle);
            const midY = center.y + midRadius * Math.sin(midAngle);
            
            const rupee = svg.append('text')
                .attr('class', 'flow-rupee-real')
                .text('‚Çπ')
                .attr('font-size', `${12 + (intensity * 4)}px`)
                .attr('fill', modelType === 'td' ? '#1e88e5' : '#ff8f00')
                .attr('font-weight', '700')
                .attr('opacity', 0)
                .attr('x', source.x)
                .attr('y', source.y)
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle');
            
            model.rupeeElements.push(rupee);
            
            const flowSpeed = 1800 / intensity;
            let startTime = Date.now();
            let isActive = true;
            
            function animate() {
                if (!model.running || !GLOBAL_STATE.isRunning || !isActive || GLOBAL_STATE.cycleCompletePause) {
                    isActive = false;
                    rupee.remove();
                    return;
                }
                
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / flowSpeed, 1);
                
                const t = progress;
                const x = (1-t)*(1-t)*source.x + 2*(1-t)*t*midX + t*t*target.x;
                const y = (1-t)*(1-t)*source.y + 2*(1-t)*t*midY + t*t*target.y;
                
                rupee.attr('x', x).attr('y', y);
                
                if (progress < 0.2) {
                    rupee.attr('opacity', progress * 5);
                } else if (progress > 0.8) {
                    rupee.attr('opacity', (1 - progress) * 5);
                } else {
                    const pulse = 0.03 * Math.sin(Date.now() / 200 + connectionIndex);
                    rupee.attr('opacity', 0.9 + pulse);
                }
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    rupee.transition()
                        .duration(150)
                        .attr('opacity', 0)
                        .attr('font-size', `${(12 + (intensity * 4)) * 0.7}px`)
                        .on('end', function() {
                            isActive = false;
                            rupee.remove();
                            
                            const index = model.rupeeElements.indexOf(rupee);
                            if (index > -1) model.rupeeElements.splice(index, 1);
                            
                            // Continue network flow
                            if (model.running && GLOBAL_STATE.isRunning && !GLOBAL_STATE.cycleCompletePause && Math.random() < 0.6) {
                                setTimeout(() => {
                                    const outgoingConnections = connections.filter((c, i) => 
                                        sectors[c[0]].id === target.id
                                    );
                                    if (outgoingConnections.length > 0) {
                                        const nextIndex = connections.indexOf(
                                            outgoingConnections[Math.floor(Math.random() * outgoingConnections.length)]
                                        );
                                        createMonthBasedNetworkFlow(modelType, nextIndex, intensity * 0.8);
                                    }
                                }, 150 + Math.random() * 150);
                            }
                        });
                }
            }
            
            startTime = Date.now();
            requestAnimationFrame(animate);
        }

        // ==================== HANDLE CYCLE COMPLETE ANIMATIONS ====================

        function handleCycleCompleteAnimations() {
            // Freeze all rupee animations during pause
            MODELS.td.flowParticles.forEach(particle => {
                particle.isActive = false;
                if (particle.element) {
                    particle.element
                        .transition()
                        .duration(300)
                        .attr('opacity', 0.3)
                        .style('transform', 'scale(0.8)');
                }
            });
            
            MODELS.bu.flowParticles.forEach(particle => {
                particle.isActive = false;
                if (particle.element) {
                    particle.element
                        .transition()
                        .duration(300)
                        .attr('opacity', 0.3)
                        .style('transform', 'scale(0.8)');
                }
            });
            
            // After 3 seconds of frozen state, fade out completely
            setTimeout(() => {
                MODELS.td.rupeeElements.forEach(rupee => {
                    rupee.transition()
                        .duration(500)
                        .attr('opacity', 0)
                        .on('end', function() {
                            d3.select(this).remove();
                        });
                });
                
                MODELS.bu.rupeeElements.forEach(rupee => {
                    rupee.transition()
                        .duration(500)
                        .attr('opacity', 0)
                        .on('end', function() {
                            d3.select(this).remove();
                        });
                });
                
                MODELS.td.rupeeElements = [];
                MODELS.bu.rupeeElements = [];
                MODELS.td.flowParticles = [];
                MODELS.bu.flowParticles = [];
            }, 3000);
        }

        // ==================== UPDATE NETWORK VISUALIZATIONS ====================

        function updateNetworkVisualizations(progress) {
            // Update network node sizes based on progress
            ['td', 'bu'].forEach(modelType => {
                const network = ENHANCED_NETWORKS[modelType];
                if (network && network.simulation) {
                    const nodes = ENHANCED_SECTOR_DATA[modelType];
                    nodes.forEach(node => {
                        if (node.type === 'core') {
                            // Grow core nodes with progress
                            const newSize = node.size * (0.8 + progress * 0.4);
                            d3.select(`#${modelType}-enhanced-network #node-${node.id}`)
                                .transition()
                                .duration(500)
                                .attr('r', newSize);
                        }
                    });
                }
            });
        }

        // ==================== INITIALIZATION ====================
        
        function init() {
            // Initialize time elapsed update
            setInterval(updateTimeElapsed, 1000);
            
            // Start the synchronized timeline
            SYNCHRONIZED_TIMELINE.start();
            
            // Initialize models
            initTopDownModel();
            initBottomUpModel();
            
            // Initialize timeline
            setTimeout(() => {
                initTimeline();
            }, 100);
            
            // Initialize enhanced features
            setTimeout(() => {
                // Initialize enhanced network visualizations
                initEnhancedNetworkVisualization('td');
                initEnhancedNetworkVisualization('bu');
                
                // Initialize pie charts
                initPieCharts();
                
                // Start month-based rupee flow
                updateRupeeFlowBasedOnMonth();
            }, 1000);
            
            // Update rupee flow based on month in the main update loop
            setInterval(() => {
                if (GLOBAL_STATE.isRunning && !GLOBAL_STATE.cycleCompletePause) {
                    updateRupeeFlowBasedOnMonth();
                }
            }, 3000);
            
            // Handle window resize
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    initTimeline();
                    if (MODELS.td.running) {
                        initTopDownModel();
                        initTopDownMechanization();
                    }
                    if (MODELS.bu.running) {
                        initBottomUpModel();
                        initBottomUpMechanization();
                    }
                }, 250);
            });
            
            console.log("ENHANCED ECONOMIC FLOW VISUALIZATION INITIALIZED");
            console.log("ALL ISSUES FIXED:");
            console.log("1. Top-down now has perfect circular paths");
            console.log("2. God-level rupee animation with bubble entry/exit");
            console.log("3. 5-second pause at cycle completion with proper handling");
            console.log("4. Enhanced flow network with 42+ sectors and zoom");
            console.log("5. God-level pie chart visualization");
            console.log("6. Month-based rupee origin flow");
            console.log("7. All existing code preserved exactly");
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
